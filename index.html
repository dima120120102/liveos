<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Time Owner</title>
<link rel="icon" type="image/png" href="pictures/favicon.png">
<style>
/* --- ОБЩИЕ УЛУЧШЕННЫЕ СТИЛИ --- */
:root {
    --bg-main: #121212;
    --bg-secondary: #1e1e1e;
    --bg-tertiary: #2a2a2a;
    --bg-hover: #333333;
    --border-color: #383838;
    --text-primary: #e0e0e0;
    --text-secondary: #a0a0a0;
    --accent-color: #007bff;
    --accent-hover: #0056b3;
    --danger-color: #e53935;
    --success-color: #4CAF50;
    --warning-color: #FFC107;
}
* {
    box-sizing: border-box;
}

/* --- КРАСИВЫЕ СТИЛИ ПРОКРУТКИ (СКРОЛЛБАРЫ) --- */
::-webkit-scrollbar {
    width: 10px; 
    height: 10px; 
}
::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}
::-webkit-scrollbar-thumb {
    background: var(--accent-color); 
    border-radius: 5px;
}
::-webkit-scrollbar-thumb:hover {
    background: var(--accent-hover);
}
* {
  scrollbar-color: var(--accent-color) var(--bg-secondary); 
  scrollbar-width: thin;
}

/* --- АНИМАЦИЯ ПОЯВЛЕНИЯ СТРАНИЦЫ --- */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    background: var(--bg-main);
    color: var(--text-primary);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    overflow-x: hidden; 
    animation: fadeIn 0.5s ease-in-out;
}
.banner{width:100%;display:flex;justify-content:center;overflow:hidden;}
.banner img{width:100%;height:auto;max-height: 400px; object-fit:cover;display:block;}

/* --- ОСНОВНАЯ СТРУКТУРА --- */
.main-container{
    display:flex;
    padding: 0 10px;
    overflow-x: hidden; 
    transition: padding 0.3s ease; 
}
.goals{
    width:240px;
    background:var(--bg-secondary);
    border-right:1px solid var(--border-color);
    padding:20px;
    display:flex;
    flex-direction:column;
    /* ИЗМЕНЕНО: Расстояние между целями */
    gap: 15px; 
    max-height: 800px; 
    overflow-y: auto; 
    position:relative; 
    flex-shrink: 0;
}
.right{
    flex:1;
    display:flex;
    flex-direction:column;
    padding:20px;
    gap:15px;
    overflow: hidden; 
}

/* --- ЭЛЕМЕНТЫ ИНТЕРФЕЙСА --- */
.btn{
    background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:10px 15px;border-radius:8px;cursor:pointer;font-weight: 600; 
    transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    display: flex; /* Для выравнивания иконки и текста */
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.btn:hover{
    background-color: var(--bg-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.btn:active { transform: scale(0.98) translateY(0); } 
.create-week{background:var(--accent-color);border-color: var(--accent-color);color: #fff;}
.create-week:hover{background:var(--accent-hover);border-color: var(--accent-hover);}

/* --- КНОПКИ УПРАВЛЕНИЯ (НОВЫЙ БЛОК) --- */
.top-controls {
    position: fixed;
    top: 15px;
    right: 20px;
    display: flex;
    gap: 10px; 
    z-index: 10000;
}
.save-all-btn, .account-control-btn {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background 0.2s, color 0.2s, transform 0.2s, box-shadow 0.2s ease; 
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 8px;
}
.save-all-btn:hover {
    background: var(--success-color);
    border-color: var(--success-color);
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.account-control-btn:hover{
    background: var(--accent-color);
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.account-control-btn img, .save-all-btn img {
    transition: filter 0.2s;
}
.account-control-btn:hover img, .save-all-btn:hover img {
    filter: invert(10%);
}
.save-all-btn.unsaved {
    border-color: var(--warning-color);
    box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 5px rgba(255, 193, 7, 0.4); }
    50% { box-shadow: 0 0 12px rgba(255, 193, 7, 0.8); }
    100% { box-shadow: 0 0 5px rgba(255, 193, 7, 0.4); }
}

/* --- ЦЕЛИ (Goal Styles) --- */
.goals h2 { margin-top: 0; color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px;}
.goal{
    background:var(--bg-tertiary);
    border-radius:8px;
    padding:10px;
    position:relative;
    transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s ease;
    min-height: 40px;
    /* ИЗМЕНЕНО: Увеличенная граница */
    border-left: 6px solid var(--success-color); 
    font-size: 16px; /* Чуть крупнее шрифт */
}
.goal:hover{
    background:var(--bg-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2); 
}
.goal .goal-remove{
    position:absolute;right:8px;top:50%;transform: translateY(-50%);opacity:0;cursor:pointer;color:var(--danger-color);font-size: 20px;
    transition: opacity 0.2s, transform 0.2s; 
}
.goal .goal-remove:hover { transform: translateY(-50%) scale(1.2); }
.goal:hover .goal-remove{opacity:1;}
.goal[contenteditable]:focus{
    outline:2px solid var(--accent-color);
    background: var(--bg-secondary);
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
}
.add-goal-btn{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:15px;
    background:#555;
    color:var(--text-primary);
    width:40px;height:40px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:24px;
    cursor:pointer;
    display:none; 
    transition: background-color 0.2s, transform 0.2s ease-out; 
}
.goals:hover .add-goal-btn{display:flex}
.add-goal-btn:hover { 
    background-color: var(--accent-color); 
    transform: translateX(-50%) translateY(-5px) scale(1.05); 
}

/* --- НЕДЕЛИ И МЕСЯЦЫ --- */
/* ИЗМЕНЕНИЕ: Увеличен максимальный размер и flex-grow для нераспределенных */
.unassigned-container {
    background-color: var(--bg-secondary);
    border-radius: 8px;
    padding: 15px;
    border: 1px solid var(--border-color);
    max-width: none; 
    /* ИЗМЕНЕНО: Сужение области нераспределенных недель */
    flex: 1 1 300px; 
    transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
}
.unassigned-container.dragover {
    border-color: var(--accent-color);
    background: rgba(0, 123, 255, 0.08);
}
.unassigned-list{
    max-height: 250px; /* Немного увеличена высота */
    overflow-y: auto;
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:10px;
    padding-right: 5px;
}
.week-item,.week-card{
    background:var(--bg-tertiary);border: 1px solid var(--border-color); border-radius:8px;padding:10px 12px;cursor:grab;display:flex;align-items:center;justify-content:space-between; 
    transition: border-color 0.2s, transform 0.2s ease, box-shadow 0.2s;
    font-weight: 500;
}
.week-item:hover { 
    border-color: var(--accent-color);
    transform: translateY(-2px); 
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.months-wrapper { overflow-x: auto; padding-bottom: 20px; flex-shrink: 0; max-height: 500px; }
.months{ display:flex; gap:15px; padding:10px 4px; width: max-content; }
.month{
    min-width:280px; 
    background-color: var(--bg-secondary);
    border-radius:12px;
    padding: 20px;
    display:flex;
    flex-direction:column;
    gap: 15px;
    flex-shrink:0; 
    border-top: 4px solid;
    transition: transform 0.3s ease, box-shadow 0.3s ease; 
}
.month:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
}
.month .m-title{text-align:center;font-weight:bold; font-size: 1.2em; margin-bottom: 5px; color: var(--accent-color);}
.month .month-weeks{display:flex;flex-direction:column;gap:8px; min-height: 40px;}
.drop-zone{border:2px dashed var(--border-color);border-radius:8px;padding:15px;text-align:center;color:var(--text-secondary);font-size:13px;transition:0.2s ease-in-out; margin-top: 10px;}
.drop-zone.dragover{border-color:var(--success-color);color:var(--success-color);background:rgba(76,175,80,0.08);}

/* --- МОДАЛЬНОЕ ОКНО: ОБЩИЕ СТИЛИ --- */
.modal{
    position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter: blur(5px);z-index:1000;display:none;align-items: center; justify-content: center;
    opacity: 0; 
    transition: opacity 0.3s ease;
}
.modal.visible { opacity: 1; } 
.modal-content {
    background: var(--bg-main);
    width: 95%;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
    transform: scale(0.95); 
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.modal.visible .modal-content { transform: scale(1); } 
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:var(--bg-secondary);border-bottom:1px solid var(--border-color);}
.modal-header .actions{display:flex;justify-content:flex-end;align-items:center;gap:15px;position:relative;}
.modal-header span{cursor:pointer;font-size:24px;position:relative; color: var(--text-secondary); transition: color 0.2s;}
.modal-header span:hover { color: var(--accent-color); }
.modal-footer { padding: 10px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; }

/* --- МОДАЛЬНОЕ ОКНО НЕДЕЛИ: УЛУЧШЕННЫЙ ДИЗАЙН --- */
.modal-content.week-editor {
    max-width: 1200px; /* Шире для удобства */
    height: 90vh;
}
.modal-header input{
    background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color);padding:8px 12px;border-radius:6px;font-size:18px;width:60%;
    transition: border-color 0.2s, box-shadow 0.2s;
}
.modal-header input:focus { 
    border-color: var(--warning-color); 
    outline: none;
    box-shadow: 0 0 8px rgba(255, 193, 7, 0.4);
} 
.menu{
    position:absolute; top:35px; right:0; background:var(--bg-tertiary); border:1px solid var(--border-color); border-radius:8px;
    display:flex; flex-direction:column; min-width:180px; z-index:200; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.4);
    opacity: 0; visibility: hidden; transform: translateY(-10px);
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
}
.menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
.menu div{padding:10px 15px;cursor:pointer;transition:background-color 0.2s, color 0.2s;display:flex;align-items:center;gap:10px;}
.menu div:hover{background:var(--accent-color); color: #fff;}
.menu div img { transition: filter 0.2s; }

.modal-body{display:flex;flex:1;overflow:hidden;}
.modal-left{width:280px;background: var(--bg-main); border-right:1px solid var(--border-color);padding:15px;overflow-y:auto; display: flex; flex-direction: column; gap: 20px;}
.modal-right{flex:1;padding:15px;display:flex;flex-direction:column;gap:15px;overflow:hidden;}
.modal-description textarea{
    width:100%;background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border-color);padding:10px;border-radius:6px; min-height: 80px; resize: vertical;
    transition: border-color 0.2s, box-shadow 0.2s;
}
.modal-description textarea:focus { 
    border-color: var(--warning-color); 
    outline: none; 
    box-shadow: 0 0 8px rgba(255, 193, 7, 0.4);
} 
.modal-days{display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); overflow-y:auto; gap:12px;flex:1; padding-bottom: 10px;}
.day{
    background: var(--bg-secondary); border-radius:10px;padding:12px;flex-shrink:0;display:flex;flex-direction:column;gap:10px;
    /* УЛУЧШЕНИЕ: Добавлена рамка сверху */
    border-top: 3px solid var(--accent-color);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.day:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.day h4{margin:0;display:flex;justify-content:space-between;align-items:center;font-size:14px; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
.tasks{display:flex;flex-direction:column;gap:8px;overflow-y:auto; flex: 1; min-height: 50px;}

/* --- НОВЫЕ СТИЛИ ДЛЯ ЗАДАЧИ В РЕДАКТОРЕ НЕДЕЛИ (Week Editor Tasks) --- */
.task-item {
    background: var(--bg-tertiary);
    border-radius: 6px;
    padding: 8px 10px;
    display: flex;
    align-items: center;
    gap: 10px; /* Отступ между элементами задачи */
    transition: background-color 0.2s, opacity 0.3s, border-left-color 0.3s;
    border-left: 3px solid var(--border-color);
    cursor: default;
}
.task-item:hover { 
    background-color: var(--bg-hover); 
    border-left-color: var(--accent-hover); 
}
.task-item[contenteditable]:focus { 
    outline: 1px solid var(--warning-color); 
    background: var(--bg-secondary); 
} 
/* Элемент для перетаскивания */
.task-drag-handle {
    cursor: grab;
    color: var(--text-secondary);
    font-size: 18px;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: color 0.2s;
}
.task-drag-handle:hover {
    color: var(--accent-color);
}
/* Время выполнения */
.task-time-input {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 2px 5px;
    border-radius: 4px;
    width: 65px; /* Фиксированная ширина для времени HH:MM */
    font-size: 13px;
    text-align: center;
    transition: border-color 0.2s;
    flex-shrink: 0;
}
.task-time-input:focus {
    border-color: var(--warning-color);
    outline: none;
}
/* Имя задачи */
.task-name {
    flex-grow: 1;
    cursor: text;
    padding: 2px 0;
    word-break: break-word; /* Для переноса длинных задач */
}
.task-name[contenteditable]:focus {
    outline: none; /* Убираем фокус, так как он уже есть на .task-item[contenteditable]:focus */
}
/* Чекбокс для выполнения */
.task-check {
    width: 20px;
    height: 20px;
    min-width: 20px; /* Фиксированная ширина */
    cursor: pointer;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: 50%;
    position: relative;
    transition: all 0.3s ease;
    flex-shrink: 0;
}
.task-check:hover {
    border-color: var(--accent-color);
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
}
/* Состояние ВЫПОЛНЕНО */
.task-item.done {
    opacity: 0.7;
    background-color: #1a2a1a; /* Темно-зеленый фон */
    border-left-color: var(--success-color); /* Зеленая полоса */
}
.task-item.done .task-name {
    text-decoration: line-through;
    color: var(--text-secondary);
    font-style: italic;
}
.task-item.done .task-check {
    background: var(--success-color);
    border-color: var(--success-color);
    transform: scale(1.1);
}
/* Анимация галочки */
.task-item.done .task-check::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    color: white;
    font-size: 14px;
    line-height: 1;
    animation: check-pop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
}
@keyframes check-pop {
    0% { transform: translate(-50%, -50%) scale(0); }
    70% { transform: translate(-50%, -50%) scale(1.3); }
    100% { transform: translate(-50%, -50%) scale(1); }
}

/* Скрываем стандартный инпут времени в Firefox и Webkit */
.task-time-input::-webkit-outer-spin-button,
.task-time-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
/* Стили для drag-and-drop */
.task-item.dragging {
    opacity: 0.5;
    transform: scale(1.02);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
}
.tasks .task-item.over {
    border-top: 2px solid var(--warning-color); /* Визуальный индикатор места вставки */
}
.task-time-input[type="time"] {
    -webkit-appearance: none;
    appearance: none;
}
/* --- КОНЕЦ НОВЫХ СТИЛЕЙ ЗАДАЧ --- */

.add-task-btn{
    margin-top:auto;background:transparent;color:var(--text-secondary);border: 1px dashed var(--border-color);padding:8px;
    border-radius:6px;cursor:pointer;font-size:13px; transition: all 0.2s; width: 100%; /* УЛУЧШЕНИЕ: Кнопка на всю ширину */
}
.add-task-btn:hover { background-color: var(--accent-color); color: #fff; border-style: solid; }
.modal-goals h4{margin:0 0 10px 0;font-size:16px; color: var(--warning-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px;}
.modal-goals ul{margin:0;padding-left:0;display:flex;flex-direction:column;
    gap: 10px; /* ИЗМЕНЕНО: Увеличен отступ */
}
/* УЛУЧШЕНИЕ: Цели в модалке стилизованы как на главной */
.modal-goals ul li{
    background:var(--bg-tertiary); padding:10px; border-radius:8px; transition:0.2s; list-style: none;
    /* ИЗМЕНЕНО: Увеличенная граница */
    border-left: 6px solid var(--success-color); 
    font-size: 15px;
}
.modal-goals ul li:hover{background:var(--bg-hover);}
.task-delete{cursor:pointer;margin-left:8px; filter: invert(50%); width: 14px; transition: filter 0.2s, transform 0.2s;}
.task-delete:hover { filter: invert(80%); transform: scale(1.1); }

/* --- МОДАЛЬНОЕ ОКНО ЛК --- */
.small-modal-content {
    max-width: 450px;
    height: auto;
    max-height: 90vh;
    padding: 20px;
    gap: 15px;
}
/* --- СТИЛИ ДЛЯ КОРЗИНЫ И РЕКЛАМЫ --- */

/* Контейнер для недель и корзины */
.top-plan-controls {
    display: flex;
    gap: 15px; /* Расстояние между нераспределёнными и корзиной */
    align-items: flex-start; /* Выравнивание сверху */
    flex-wrap: wrap; 
    /* NEW: Убеждаемся, что корзина будет справа, когда она видна */
    justify-content: flex-start; 
}

/* ИЗМЕНЕНИЕ: Сужение области нераспределенных недель */
.unassigned-container {
    background-color: var(--bg-secondary);
    border-radius: 8px;
    padding: 15px;
    border: 1px solid var(--border-color);
    max-width: none; 
    /* ИЗМЕНЕНО: Новое flex-правило для сужения */
    flex: 1 1 300px; 
    transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
}
.unassigned-container.dragover {
    border-color: var(--accent-color);
    background: rgba(0, 123, 255, 0.08);
}

/* ИЗМЕНЕНИЕ: Скрытая корзина */
.trash-container {
    background-color: var(--bg-secondary);
    border-radius: 8px;
    padding: 15px;
    border: 1px dashed var(--danger-color); /* Стиль корзины */
    /* ИЗМЕНЕНО: Теперь корзина не display: none, а управляется flex-grow и opacity */
    flex: 0 0 200px; /* Фиксированная/минимальная ширина на десктопе */
    display: flex; /* Постоянный flex для анимации */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    transition: background-color 0.2s, border-color 0.2s, opacity 0.3s, max-height 0.3s, flex 0.3s ease;
    height: 100%; 
    max-height: 250px;
    opacity: 0;
    /* Уменьшаем размер и убираем кликабельность, когда скрыта */
    pointer-events: none;
}
.trash-container.visible { /* Класс для отображения */
    opacity: 1;
    pointer-events: auto; /* Возвращаем кликабельность */
}

.trash-container .trash-icon {
    filter: invert(30%) sepia(80%) saturate(700%) hue-rotate(330deg); /* Красный цвет */
    transition: transform 0.2s;
}
.trash-container.dragover {
    background-color: rgba(229, 57, 53, 0.15); /* Красный фон при наведении */
    border-color: var(--danger-color);
    box-shadow: 0 0 10px rgba(229, 57, 53, 0.4);
}
.trash-container.dragover .trash-icon {
    transform: scale(1.2) rotate(-5deg);
}
.trash-label {
    margin-top: 5px;
    font-weight: bold;
    color: var(--danger-color);
}
.trash-hint {
    font-size: 10px;
    color: var(--text-secondary);
    margin-top: 5px;
}

/* ИЗМЕНЕНИЕ: Группа кнопок над нераспределёнными неделями */
.top-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}
.open-trash-btn {
    background: var(--danger-color);
    border-color: var(--danger-color);
    color: #fff;
}
.open-trash-btn:hover {
    background: #c32727;
    border-color: #c32727;
}

/* Адаптивность для мобильных */
@media (max-width: 768px) {
    .top-plan-controls {
        flex-direction: column;
        gap: 10px;
    }
    /* ИЗМЕНЕНИЕ: Корзина на мобильных */
    .trash-container {
        max-height: 100px;
        flex-direction: row;
        justify-content: space-around;
        padding: 10px 20px;
        width: 100%;
        min-height: auto;
        flex: 1 1 100%; /* Занимает всю ширину на мобильных */
    }
    .trash-hint { display: none; } /* Скрываем подсказку на мобильных */
    
    .top-buttons {
        flex-wrap: wrap;
    }
}

/* --- СТИЛИ ДЛЯ КНОПКИ В НИЖНЕМ ЛЕВОМ УГЛУ (AI Совет) --- */
#aiButtonContainer {
    position: fixed;
    bottom: 20px; /* Отступ от нижнего края */
    left: 20px; /* Отступ от левого края */
    z-index: 9999; /* Поверх остальных элементов */
}
#aiButtonContainer .btn {
    background: #39556d; /* Цвет, чтобы отличался */
    border-color: #39556d; 
    color: #fff;
    padding: 12px 20px;
    font-size: 16px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
}
#aiButtonContainer .btn:hover {
    background: #476a8a;
    border-color: #476a8a;
}

@media (max-width: 768px) {
    #aiButtonContainer {
        bottom: 15px;
        left: 15px;
    }
    #aiButtonContainer .btn {
        padding: 10px 15px;
        font-size: 14px;
    }
}

/* --- СТИЛИ ДЛЯ ТРЕКЕРА ПРИВЫЧЕК --- */
.habit-tracker{background:var(--bg-secondary);padding:25px 20px; margin-bottom: 20px;}
.habit-tracker h2 { margin-top: 0; color: var(--success-color); }
.habit-controls{display:flex;gap:10px;margin-bottom:20px;align-items:center; flex-wrap: wrap;}
.habit-controls input{flex:1;background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:10px 12px;border-radius:8px; min-width: 200px;}
.habit-table-wrapper { overflow-x: auto; }
.habit-table{width:100%;border-collapse:collapse;table-layout:fixed; min-width: 600px;}
.habit-table th, .habit-table td{border:1px solid var(--border-color);padding:10px;text-align:center; transition: background-color 0.2s;}
.habit-table th{background:var(--bg-tertiary);font-weight:600; position: sticky; top: 0;}
.habit-table td:first-child, .habit-table th:first-child { text-align:left;font-weight:bold; width: 100px; position: sticky; left: 0; background: var(--bg-tertiary); }
.habit-table tr:hover td { background-color: var(--bg-hover); }
.habit-table input[type="checkbox"]{width:20px;height:20px;cursor:pointer; accent-color: var(--success-color); transform: scale(1.1); transition: transform 0.1s;} 
.habit-table input[type="checkbox"]:hover { transform: scale(1.2); }
.progress-col { width: 150px; }
.progress-bar-container { width: 100%; height: 22px; background-color: var(--bg-tertiary); border-radius: 5px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color);}
.progress-bar { position: absolute; left: 0; top: 0; height: 100%; background-color: var(--success-color); border-radius: 5px; transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
.progress-bar-text { position: relative; z-index: 1; font-size: 12px; font-weight: bold; color: #fff; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); }
/* ИСПРАВЛЕНИЕ: Стили для удаления привычки */
.habit-table th { position: relative; }
.habit-header-content { display: flex; justify-content: space-between; align-items: center; gap: 5px; }
.habit-header-content span[contenteditable] { flex-grow: 1; text-align: left; }
.remove-habit {
    color: var(--danger-color); font-size: 18px; font-weight: bold; cursor: pointer; line-height: 1;
    opacity: 0.5; transition: opacity 0.2s, transform 0.2s; flex-shrink: 0;
}
.remove-habit:hover { opacity: 1; transform: rotate(90deg); }

/* СТИЛИ ДЛЯ СВОРАЧИВАНИЯ ТАБЛИЦЫ ПРИВЫЧЕК */
.habit-table-container { overflow: hidden; position: relative; transition: max-height 0.5s ease-out; max-height: 500px; }
.habit-table-container.collapsed { max-height: 250px; }
.toggle-history-btn { width: 100%; text-align: center; background: var(--bg-tertiary); color: var(--accent-color); padding: 10px; border: 1px solid var(--border-color); border-top: none; cursor: pointer; font-weight: 600; transition: background 0.2s; border-radius: 0 0 8px 8px; }
.toggle-history-btn:hover { background: var(--bg-hover); }

/* --- СТИЛИ ДЛЯ ТРЕКЕРА НАСТРОЕНИЯ --- */
.mood-tracker { background: var(--bg-secondary); padding: 25px 20px; }
.mood-tracker h2 { margin-top: 0; color: var(--warning-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px;}
.mood-selection { display: flex; gap: 15px; justify-content: center; align-items: center; margin-bottom: 25px; }
.mood-option { font-size: 40px; cursor: pointer; transition: transform 0.2s, opacity 0.2s, text-shadow 0.2s; opacity: 0.6; }
.mood-option:hover { transform: scale(1.15) rotate(-5deg); opacity: 1; }
.mood-option.selected { opacity: 1; transform: scale(1.25); text-shadow: 0 0 15px var(--warning-color); }
.mood-history-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
.mood-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; background: var(--bg-tertiary); padding: 10px; border-radius: 8px; }
.mood-calendar-day { padding: 8px 0; font-size: 14px; font-weight: 600; color: var(--text-secondary); }
.mood-calendar-cell { padding: 5px 0; background: var(--bg-secondary); border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 40px; cursor: default; transition: transform 0.2s; }
.mood-calendar-cell:hover { transform: scale(1.05); }
.mood-calendar-cell.empty { background: var(--bg-main); cursor: default; }
.day-number { font-size: 12px; color: var(--text-secondary); }
.day-mood { font-size: 18px; margin-top: 2px; }
.current-month-select { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 6px; cursor: pointer; }

/* --- СТИЛИ ДЛЯ ЛИЧНОГО КАБИНЕТА --- */
.profile-section { display: flex; flex-direction: column; gap: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; }
.profile-section h3 { margin: 0; color: var(--accent-color); font-size: 1.1em; border-bottom: 1px dashed var(--border-color); padding-bottom: 5px; }
.profile-input-group { display: flex; gap: 10px; align-items: center; }
.profile-input-group input { flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 12px; border-radius: 6px; }
.btn-save-nick { background: var(--success-color); border-color: var(--success-color); }
.btn-save-nick:hover { background: #3e8e41; }
.btn-logout { background: var(--bg-tertiary); border-color: var(--border-color); }
.btn-logout:hover { background: var(--bg-hover); }
.btn-delete { background: var(--danger-color); border-color: var(--danger-color); }
.btn-delete:hover { background: #c32727; }

/* --- СТИЛИ ДЛЯ АНИМАЦИИ ЗАГРУЗКИ --- */
#loadingOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; 
    flex-direction: column; justify-content: center; align-items: center; color: var(--text-primary); font-size: 1.2em;
    z-index: 10001; opacity: 0; transition: opacity 0.3s ease;
}
.spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid var(--accent-color); width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* --- СТИЛИ ДЛЯ МОДАЛЬНОГО ОКНА ПОДТВЕРЖДЕНИЯ (NEW) --- */
.confirm-modal-content {
    max-width: 400px;
    padding: 20px;
    text-align: center;
    gap: 20px;
}
.confirm-modal-content h2 {
    color: var(--danger-color);
    margin-top: 0;
}
.confirm-modal-content p {
    margin-bottom: 25px;
}
.confirm-actions {
    display: flex;
    justify-content: space-around;
    gap: 10px;
}
.confirm-actions .btn {
    flex: 1;
}
.checkbox-group {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 15px;
    font-size: 14px;
}
.checkbox-group input[type="checkbox"] {
    width: 16px;
    height: 16px;
    margin-right: 8px;
    cursor: pointer;
    accent-color: var(--danger-color);
}


/* --- НОВЫЕ СТИЛИ ДЛЯ БОКОВОГО ОКНА AI-СОВЕТА (DRAWER) --- */
.advice-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); /* Более темный оверлей */
    display: none;
    z-index: 10000000000;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.advice-modal-overlay.visible {
    display: block;
    opacity: 1;
}

.advice-modal-drawer {
    position: fixed;
    top: 0;
    right: 0; /* Выдвигаем справа */
    width: 400px; /* Ширина бокового окна */
    max-width: 90%; 
    height: 100%;
    background-color: var(--bg-secondary);
    box-shadow: -6px 0 15px rgba(0, 0, 0, 0.4);
    z-index: 100100000000;
    display: flex;
    flex-direction: column;
    /* Изначально за экраном */
    transform: translateX(100%); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.advice-modal-overlay.visible .advice-modal-drawer {
    transform: translateX(0);
}

.advice-drawer-header {
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
}
.advice-drawer-header h2 {
    margin: 0;
    color: var(--accent-color);
    font-size: 1.3em;
}

.advice-drawer-close {
    background: none;
    border: none;
    font-size: 30px;
    cursor: pointer;
    color: var(--text-secondary);
    line-height: 1;
    transition: color 0.2s;
}
.advice-drawer-close:hover {
    color: var(--danger-color);
}

.advice-drawer-content {
    padding: 20px;
    flex-grow: 1;
    overflow-y: auto; /* Прокрутка для текста совета */
}
/* Стиль для текста совета, чтобы он выглядел красиво */
.advice-drawer-content p {
    white-space: pre-wrap;
    line-height: 1.7;
    font-size: 15px;
    color: var(--text-primary);
    padding-right: 5px; /* Немного места для скроллбара */
}

/* --- НОВЫЕ СТИЛИ ДЛЯ СТИЛИЗАЦИИ MARKDOWN В AI СОВЕТЕ --- */
.advice-drawer-content h3 {
    font-size: 1.4em;
    font-weight: 700;
    color: var(--accent-color); /* Синий акцент для заголовков */
    margin-top: 25px;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 2px solid var(--border-color);
}
.advice-drawer-content ul {
    list-style: none;
    padding-left: 0;
    margin-top: 0;
}
.advice-drawer-content li {
    margin-bottom: 8px;
    line-height: 1.5;
    padding-left: 18px;
    position: relative;
}
.advice-drawer-content li::before {
    content: '•';
    color: var(--warning-color); /* Желтый акцент для пунктов */
    font-weight: bold;
    display: inline-block;
    width: 1em;
    margin-left: -1em;
    position: absolute;
    left: 0;
}
.advice-drawer-content strong {
    color: var(--text-primary);
    font-weight: 600;
}
/* --- СТИЛИ ДЛЯ КНОПКИ БАЗЫ ЗНАНИЙ --- */
.knowledge-base-btn {
    color: #fff;
    border: none;
    text-decoration: none; /* Убираем подчеркивание у ссылки */
    background: linear-gradient(45deg, #007bff, #6f42c1, #d63384);
    background-size: 200% 200%;
    animation: gradient-animation 5s ease infinite;
}
.knowledge-base-btn:hover {
    color: #fff;
    box-shadow: 0 0 15px rgba(111, 66, 193, 0.7);
}
@keyframes gradient-animation {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
/* Основные стили футера */
#main-footer {
    position: relative; /* Важно для размещения дочерних элементов */
    width: 100%;
    min-height: 200px; /* Задайте желаемую высоту */
    background-color: #333; /* Темный фон для лучшего контраста с частицами */
    color: #fff;
    padding: 20px 0;
    overflow: hidden; /* Скрывает частицы, выходящие за границы */
}
/* Стили для контейнера анимации */
#particles-js {
    position: absolute; /* Позиционируем на весь футер */
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    /* Убедитесь, что контент футера выше, чем анимация */
    z-index: 1;
}
/* Стили для контента (текста) футера */
.footer-content {
    position: relative;
    text-align: center;
    padding-top: 50px; /* Отступ сверху для центрирования */
    /* Важно! Контент должен быть выше анимации */
    z-index: 2;
}
.footer-content p {
    margin: 0;
    font-size: 14px; /* Убедитесь, что цвет текста подходит к дизайну */
}
/* --- АДАПТИВНОСТЬ ДЛЯ МОБИЛЬНЫХ УСТРОЙСТВ --- */
@media (max-width: 768px) {
    body {
        font-size: 14px;
    }
    .main-container {
        flex-direction: column;
        padding: 0;
        overflow-x: hidden;
    }
    .goals {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        padding: 15px;
        height: auto;
        max-height: none;
        overflow-y: visible;
    }
    .right {
        padding: 15px;
        overflow-y: visible;
    }
    .months-wrapper {
        overflow-x: auto;
    }
    .top-controls {
        top: 10px;
        right: 10px;
        gap: 5px;
        flex-direction: column-reverse;
        align-items: flex-end;
    }
    .save-all-btn, .account-control-btn {
        font-size: 12px;
        padding: 6px 10px;
    }
    .habit-controls {
        flex-direction: column;
        align-items: stretch;
    }
    .modal-content.week-editor {
        width: 100%;
        height: 100%;
        border-radius: 0;
    }
    .modal-body {
        flex-direction: column;
    }
    .modal-left {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        max-height: 200px;
    }
    .modal-right {
        overflow-y: auto;
    }
    .modal-days {
        grid-template-columns: 1fr;
    }
    .modal-header input {
        width: 50%;
    }
    .mood-calendar {
        grid-template-columns: repeat(4, 1fr);
    }
    .mood-option {
        font-size: 30px;
    }
    .small-modal-content {
        max-width: 100%;
        margin: 0;
        border-radius: 0;
    }
    /* Адаптация боковой панели AI для... */
}
</style>
</head>
<body>
<div class="top-controls">
    <button class="save-all-btn" id="saveAllBtn">
        <img src="pictures/save.svg" alt="Сохранить" width="16">
        Сохранить
    </button>
    <button class="account-control-btn" id="authButton">
        <img src="pictures/user.svg" alt="Аккаунт" width="16">
        Аккаунт
    </button>
</div>

<div class="banner">
    <img src="pictures/banner.jpg" alt="Планирование">
</div>

<div class="main-container">
    <div class="goals">
        <h2>Цели</h2>
        <div id="goalsList">
            </div>
        <button class="btn" id="addGoalButton">
            ✚ Добавить цель
        </button>
    </div>

    <div class="right">
        <div class="top-plan-controls">
            <div class="unassigned-container" id="unassignedWeeksContainer">
                <div class="top-buttons">
                    <button class="btn create-week" id="createWeekBtn">
                        <img src="pictures/plus.svg" alt="Создать" width="16"> Создать неделю
                    </button>
                    <button class="btn open-trash-btn" id="toggleTrashBtn">
                        <img src="pictures/trash.svg" alt="Корзина" width="16"> Корзина
                    </button>
                </div>
                <h4>Нераспределенные недели</h4>
                <div class="unassigned-list" id="unassignedWeeksList">
                    <p class="drop-zone">Перетащите сюда неназначенные недели</p>
                </div>
            </div>
            
            <div class="trash-container" id="trashContainer">
                <img class="trash-icon" src="pictures/trash-full.svg" alt="Корзина" width="40" height="40">
                <span class="trash-label">Корзина</span>
                <span class="trash-hint">Перетащите сюда недели для удаления</span>
            </div>
        </div>

        <div class="months-wrapper">
            <div class="months" id="monthsContainer">
                </div>
        </div>

        <div class="habit-tracker">
            <h2>Трекер привычек</h2>
            <div class="habit-controls">
                <input type="text" id="newHabitInput" placeholder="Введите новую привычку">
                <button class="btn create-week" id="addHabitBtn">
                    ✚ Добавить привычку
                </button>
            </div>
            <div class="habit-table-wrapper">
                <div class="habit-table-container" id="habitTableContainer">
                    <table class="habit-table" id="habitTable">
                        <thead>
                            <tr>
                                <th>Привычка</th>
                                <th class="progress-col">Прогресс (30 дн)</th>
                            </tr>
                        </thead>
                        <tbody id="habitTableBody">
                            </tbody>
                    </table>
                </div>
                <button class="toggle-history-btn" id="toggleHistoryBtn">
                    Показать всю историю
                </button>
            </div>
        </div>

        <div class="mood-tracker">
            <h2>Трекер настроения</h2>
            <div class="mood-history-controls">
                <button class="btn" id="prevMonthBtn">←</button>
                <select id="moodMonthSelect" class="current-month-select"></select>
                <button class="btn" id="nextMonthBtn">→</button>
            </div>
            <div class="mood-selection" id="moodSelection">
                </div>
            <div class="mood-calendar" id="moodCalendar">
                </div>
        </div>
    </div>
</div>

<div id="aiButtonContainer">
    <button class="btn" id="openAdviceDrawerBtn">
        <img src="pictures/lightbulb.svg" alt="Совет AI" width="20">
        AI Совет
    </button>
</div>

<div class="modal" id="weekEditorModal">
    <div class="modal-content week-editor">
        <div class="modal-header">
            <input type="text" id="weekNameInput" placeholder="Название недели">
            <div class="actions">
                <span class="menu-dots" onclick="toggleMenu(event)">•••</span>
                <div class="menu" id="weekMenu">
                    <div id="duplicateWeekBtn"><img src="pictures/copy.svg" alt="Копировать" width="16"> Дублировать неделю</div>
                    <div id="deleteWeekBtn"><img src="pictures/trash.svg" alt="Удалить" width="16"> Удалить неделю</div>
                </div>
                <span class="close-modal" id="closeWeekEditorModal">&times;</span>
            </div>
        </div>
        <div class="modal-body">
            <div class="modal-left">
                <div class="modal-description">
                    <h4>Описание недели</h4>
                    <textarea id="weekDescriptionTextarea" placeholder="Напишите подробное описание или основные цели недели..."></textarea>
                </div>
                <div class="modal-goals">
                    <h4>Цели на неделю</h4>
                    <ul id="weekGoalsList">
                        </ul>
                </div>
            </div>
            <div class="modal-right">
                <div class="modal-days" id="modalDaysContainer">
                    </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" id="saveWeekEditorChanges">Сохранить изменения</button>
        </div>
    </div>
</div>

<div class="modal" id="accountModal">
    <div class="modal-content small-modal-content">
        </div>
</div>

<div class="modal" id="confirmModal">
    <div class="modal-content confirm-modal-content">
        </div>
</div>

<div class="advice-modal-overlay" id="adviceModalOverlay">
    <div class="advice-modal-drawer" id="adviceModalDrawer">
        <div class="advice-drawer-header">
            <h2>AI Советник</h2>
            <button class="advice-drawer-close" id="closeAdviceDrawerBtn">&times;</button>
        </div>
        <div class="advice-drawer-content" id="adviceDrawerContent">
            </div>
    </div>
</div>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <span>Загрузка данных...</span>
</div>

<footer id="main-footer">
    <div id="particles-js"></div>
    <div class="footer-content">
        <p>&copy; 2025 Time Owner. Все права защищены.</p>
        <p><a href="#" class="knowledge-base-btn btn">База знаний</a> | <a href="#" class="knowledge-base-btn btn">О нас</a></p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/tsparticles-slim@2.0.6/tsparticles.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// =========================================================================
//                  КОНФИГУРАЦИЯ И ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
// =========================================================================

const SUPABASE_URL = 'ВАШ_SUPABASE_URL';
const SUPABASE_ANON_KEY = 'ВАШ_SUPABASE_ANON_KEY';
const STORAGE_KEY_AUTH = 'supabase.auth.token';
const STORAGE_KEY_DATA = 'app_data';

let supabase;
let data = { 
    weeks: [], 
    goals: [
        { id: 'g-1', name: 'Выучить 100 новых английских слов' },
        { id: 'g-2', name: 'Прочитать 2 книги по личному росту' }
    ], 
    habits: [], 
    mood: [] 
};
let currentMoodMonth = new Date().getMonth();
let currentMoodYear = new Date().getFullYear();

// =========================================================================
//                  РАЗДЕЛ: УПРАВЛЕНИЕ ЗАДАЧАМИ В РЕДАКТОРЕ НЕДЕЛИ (D&D, Time, Done)
// =========================================================================

/**
 * [НОВАЯ ФУНКЦИЯ] Определяет, над каким элементом находится курсор для вставки.
 * @param {HTMLElement} container - Контейнер (список задач дня)
 * @param {number} y - Координата Y курсора
 * @returns {HTMLElement | null} - Элемент, перед которым нужно вставить перетаскиваемый элемент, или null.
 */
function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2; // Центр элемента
        
        // Находим элемент, центр которого ниже курсора, но он сам ближе всего к курсору.
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: -Infinity, element: null }).element; // Возвращаем null если нет ближайшего
}

/**
 * [НОВАЯ ФУНКЦИЯ] Вспомогательная функция для создания DOM-элемента задачи.
 * Включает: Drag Handle, Time Input, Task Name, Completion Checkbox, Delete Button.
 * @param {object} task - Объект задачи
 * @param {string} dayName - Название дня (для контекста сохранения)
 * @param {string} weekId - ID недели
 * @returns {HTMLElement}
 */
function createTaskElement(task, dayName, weekId) {
    const taskEl = document.createElement('div');
    taskEl.classList.add('task-item');
    taskEl.setAttribute('data-task-id', task.id);
    taskEl.setAttribute('draggable', true); // Активируем Drag and Drop
    taskEl.setAttribute('contenteditable', false); // Отключаем общее редактирование, чтобы оставить его только для span

    // 1. Добавляем класс 'done', если задача выполнена
    if (task.isDone) {
        taskEl.classList.add('done');
    }

    // 2. Структура задачи
    taskEl.innerHTML = `
        <div class="task-drag-handle">☰</div>
        <input type="time" class="task-time-input" value="${task.time || ''}" title="Время выполнения">
        <span class="task-name" contenteditable="true" spellcheck="false">${task.name}</span>
        <div class="task-check"></div>
        <img class="task-delete" src="pictures/trash.svg" alt="Удалить">
    `;
    
    // Получаем внутренние элементы для работы с ними
    const taskNameEl = taskEl.querySelector('.task-name');
    const timeInputEl = taskEl.querySelector('.task-time-input');
    const checkEl = taskEl.querySelector('.task-check');
    const deleteBtnEl = taskEl.querySelector('.task-delete');

    // --- ОБРАБОТЧИКИ СОБЫТИЙ ЗАДАЧИ ---

    // 1. Отметка выполнения (с красивой анимацией)
    checkEl.addEventListener('click', () => {
        task.isDone = !task.isDone;
        taskEl.classList.toggle('done', task.isDone);
        
        // Сохранение данных
        if (typeof saveData === 'function') saveData(); 
        
        // Дополнительная логика для сброса анимации (см. CSS @keyframes check-pop)
        if (task.isDone) {
             // Используем небольшой трюк для перезапуска CSS-анимации
             taskEl.classList.remove('temp-anim');
             void taskEl.offsetWidth; 
             taskEl.classList.add('temp-anim');
             taskEl.addEventListener('animationend', () => taskEl.classList.remove('temp-anim'), { once: true });
        }
    });

    // 2. Изменение текста задачи
    taskNameEl.addEventListener('input', () => {
        task.name = taskNameEl.innerText.trim();
        if (typeof saveData === 'function') saveData();
    });

    // 3. Изменение времени задачи
    timeInputEl.addEventListener('change', () => {
        task.time = timeInputEl.value; // 'HH:MM' или пустая строка
        if (typeof saveData === 'function') saveData();
    });
    
    // 4. Удаление задачи
    deleteBtnEl.addEventListener('click', (e) => {
        if (!window.data || !window.data.weeks) return;
        
        // Находим массив задач для этого дня
        const week = window.data.weeks.find(w => w.id === weekId);
        const day = week.days.find(d => d.name === dayName);
        
        day.tasks = day.tasks.filter(t => t.id !== task.id);
        
        // Анимация исчезновения и удаление
        taskEl.style.maxHeight = '0';
        taskEl.style.opacity = '0';
        taskEl.style.paddingTop = '0';
        taskEl.style.paddingBottom = '0';
        taskEl.style.marginBottom = '0';
        taskEl.addEventListener('transitionend', () => {
            taskEl.remove();
            if (typeof saveData === 'function') saveData(); 
            // Обновляем отображение, если нужно
            if (typeof renderDays === 'function') renderDays(weekId); 
        });
    });

    // --- DRAG-AND-DROP ЛОГИКА (TASK) ---
    
    // Начало перетаскивания
    taskEl.addEventListener('dragstart', (e) => {
        taskEl.classList.add('dragging');
        // Сохраняем данные о перетаскиваемой задаче
        e.dataTransfer.setData('text/plain', JSON.stringify({
            taskId: task.id,
            dayName: dayName,
            weekId: weekId
        }));
        e.dataTransfer.effectAllowed = 'move';
        // Устанавливаем изображение-заглушку, чтобы избежать проблем с курсором
        e.dataTransfer.setDragImage(taskEl, 10, 10);
    });

    // Конец перетаскивания
    taskEl.addEventListener('dragend', () => {
        taskEl.classList.remove('dragging');
        // Убираем временные классы со всех элементов
        document.querySelectorAll('.task-item.over').forEach(item => item.classList.remove('over'));
    });
    
    return taskEl;
}

/**
 * [МОДИФИКАЦИЯ/ЗАМЕНА] Обновленный рендеринг задач дня с учетом новой структуры и D&D.
 * Предполагается, что эта функция вызывается при открытии редактора недели.
 * @param {string} weekId
 */
function renderDays(weekId) {
    if (!window.data || !window.data.weeks) return;

    const week = window.data.weeks.find(w => w.id === weekId);
    if (!week) return;

    // Находим контейнер дней в модальном окне
    const modalDaysContainer = document.querySelector('#modalDaysContainer');
    if (!modalDaysContainer) return;

    modalDaysContainer.innerHTML = ''; // Очищаем

    week.days.forEach(day => {
        // Создание элемента дня (day element)
        const dayEl = document.createElement('div');
        dayEl.classList.add('day');
        dayEl.setAttribute('data-day-name', day.name);
        dayEl.setAttribute('data-week-id', weekId);

        dayEl.innerHTML = `
            <h4>${day.name}</h4>
            <div class="tasks"></div>
            <button class="add-task-btn">✚ Добавить задачу</button>
        `;
        
        const tasksContainer = dayEl.querySelector('.tasks');

        // Рендеринг задач
        // Если поле isDone или time отсутствует (для старых задач), добавляем его с дефолтными значениями
        day.tasks.forEach(task => {
            if (typeof task.isDone === 'undefined') task.isDone = false;
            if (typeof task.time === 'undefined') task.time = '';
            
            const taskEl = createTaskElement(task, day.name, weekId);
            tasksContainer.appendChild(taskEl);
        });

        // Обработчик для кнопки добавления задачи
        dayEl.querySelector('.add-task-btn').addEventListener('click', () => {
             const newTask = {
                id: 'task-' + Date.now(), // Простой уникальный ID
                name: 'Новая задача',
                isDone: false,
                time: ''
            };
            day.tasks.push(newTask);
            
            // Рендерим новую задачу
            const newTaskEl = createTaskElement(newTask, day.name, weekId);
            tasksContainer.appendChild(newTaskEl);
            
            // Фокусируемся на новой задаче
            const taskNameSpan = newTaskEl.querySelector('.task-name');
            taskNameSpan.focus();
            // Перемещаем курсор в конец текста
            const range = document.createRange();
            const sel = window.getSelection();
            range.selectNodeContents(taskNameSpan);
            range.collapse(false); // Свернуть в конец
            sel.removeAllRanges();
            sel.addRange(range);
            
            if (typeof saveData === 'function') saveData();
        });

        // --- DRAG-AND-DROP ЛОГИКА (TASKS CONTAINER) ---

        tasksContainer.addEventListener('dragover', (e) => {
            e.preventDefault(); 
            e.dataTransfer.dropEffect = 'move';
            
            // Удаляем старые индикаторы
            document.querySelectorAll('.tasks .task-item.over').forEach(item => item.classList.remove('over'));

            const draggingItem = document.querySelector('.task-item.dragging');
            if (!draggingItem) return;

            // Определяем ближайший элемент, над которым находится курсор
            const afterElement = getDragAfterElement(tasksContainer, e.clientY);
            
            if (afterElement) {
                // Если элемент найден, добавляем класс перед ним
                afterElement.classList.add('over');
            }
        });

        tasksContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            
            // Удаляем класс 'over' после падения
            document.querySelectorAll('.tasks .task-item.over').forEach(item => item.classList.remove('over'));

            const dataTransfer = JSON.parse(e.dataTransfer.getData('text/plain'));
            const draggedTaskId = dataTransfer.taskId;
            const draggedDayName = dataTransfer.dayName;
            const draggedWeekId = dataTransfer.weekId; // Получаем ID недели, откуда пришла задача
            
            const draggingItem = document.querySelector(`[data-task-id="${draggedTaskId}"]`);
            if (!draggingItem) return;
            
            const afterElement = getDragAfterElement(tasksContainer, e.clientY);

            // 1. Обновляем DOM
            if (afterElement == null) {
                tasksContainer.appendChild(draggingItem);
            } else {
                tasksContainer.insertBefore(draggingItem, afterElement);
            }
            
            // 2. Обновляем структуру данных:
            
            const oldWeek = window.data.weeks.find(w => w.id === draggedWeekId);
            const oldDay = oldWeek.days.find(d => d.name === draggedDayName);
            
            // Находим и удаляем задачу из старого массива
            const taskIndex = oldDay.tasks.findIndex(t => t.id === draggedTaskId);
            if (taskIndex === -1) return; // Ошибка: задача не найдена
            
            const [taskToMove] = oldDay.tasks.splice(taskIndex, 1);
            
            const newDayName = dayEl.getAttribute('data-day-name');
            const newDay = week.days.find(d => d.name === newDayName);
            
            // Если дни разные, нужно обновить dayName в объекте задачи (хотя в нашем случае weekId и dayName не хранятся в task, 
            // они определяются местоположением, но для полной чистоты кода лучше перерендерить)
            
            // Полностью пересоздаем массив задач в новом дне по порядку из DOM:
            const newTasksOrderIDs = Array.from(tasksContainer.querySelectorAll('.task-item')).map(el => el.getAttribute('data-task-id'));
            
            // Собираем новый массив задач для нового дня:
            const newDayTasksInOrder = newTasksOrderIDs.map(id => {
                // Ищем задачу, которую мы только что переместили
                if (id === taskToMove.id) return taskToMove;
                // Ищем существующую задачу, которая должна была остаться в новом дне
                // Поскольку мы уже вырезали taskToMove, здесь будут только те, что были изначально в newDay
                return newDay.tasks.find(t => t.id === id); 
            }).filter(Boolean);
            
            // Добавляем перемещенную задачу в новый массив, если она еще не там (важно, если перетаскивание было из другого дня)
            // Новая логика: сначала очищаем newDay.tasks, затем восстанавливаем порядок
            newDay.tasks = [];
            
            Array.from(tasksContainer.querySelectorAll('.task-item')).forEach(el => {
                const taskId = el.getAttribute('data-task-id');
                const existingTaskInNewDay = week.days.flatMap(d => d.tasks).find(t => t.id === taskId);
                if (existingTaskInNewDay) {
                     newDay.tasks.push(existingTaskInNewDay);
                } else if (taskId === taskToMove.id) {
                     newDay.tasks.push(taskToMove);
                }
            });


            if (typeof saveData === 'function') saveData();
            
            // Перерисовываем весь блок дней, чтобы гарантировать корректное обновление контекста JS (dayName, weekId)
            // И чтобы визуально задачи из другого дня обновились
            if (typeof renderDays === 'function') renderDays(weekId); 
        });

        modalDaysContainer.appendChild(dayEl);
    });
}

// =========================================================================
//                  ОСТАЛЬНЫЕ ФУНКЦИИ (MOCK/ПЛАГИНЫ)
// =========================================================================
// Примечание: Для работы этого кода требуется полный набор функций
// (saveData, loadDataFromSupabase, renderAll, updateAuthButton, renderHabitTracker и т.д.).
// Здесь приведены необходимые заглушки и главная функция init.

function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }
function updateAuthButton() { /* ... logic ... */ }
function renderAll() { /* ... logic ... */ }
function renderHabitTracker() { /* ... logic ... */ }
function updateMoodSelect() { /* ... logic ... */ }
function renderMoodCalendar() { /* ... logic ... */ }
function openWeekEditor(weekId) { /* ... logic calling renderDays(weekId) ... */ }
function toggleMenu(event) { /* ... logic ... */ }
function saveData() { 
    // console.log("Data saved:", data);
    // localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(data)); 
}
async function loadDataFromSupabase() {
    // return JSON.parse(localStorage.getItem(STORAGE_KEY_DATA)) || data;
    return data;
}


/**
 * [ФУНКЦИЯ ИНИЦИАЛИЗАЦИИ]
 */
async function init() {
    // Проверяем, загружена ли библиотека Supabase
    if (window.supabase) {
        // ✅ Инициализируем клиент Supabase
        // Заглушка, так как SUPABASE_URL и KEY не предоставлены
        // supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        // console.error("Supabase library not found...");
        // document.body.innerHTML = '<h2 style="color: red; text-align: center; margin-top: 50px;">Ошибка: Не удалось загрузить библиотеку Supabase.</h2>';
        // return;
    }

     const authKey = localStorage.getItem(STORAGE_KEY_AUTH);
    // ✅ Ранний выход, если нет ключа (если не заглушка)
    // if (!authKey) { 
    //     window.location.href = 'login.html'; 
    //     return; 
    // }

    updateAuthButton();
    // data = await loadDataFromSupabase();  

    if (data) {
        renderAll();
        renderHabitTracker();
        updateMoodSelect();
        renderMoodCalendar();
        // Назначаем обработчики для модалки, чтобы новые функции работали
        document.getElementById('closeWeekEditorModal')?.addEventListener('click', () => { /* closeModal('weekEditorModal') */ });
        document.getElementById('weekEditorModal')?.addEventListener('click', (e) => { 
            if (e.target === e.currentTarget) { /* closeModal('weekEditorModal') */ } 
        });
        document.getElementById('saveWeekEditorChanges')?.addEventListener('click', () => { 
             // Logic to find current week and call saveData()
             if (typeof saveData === 'function') saveData();
             // closeModal('weekEditorModal');
        });
        
        // Добавить обработчики D&D для недели/месяца, если они есть
    } else {
        // document.body.innerHTML = '<h2 style="color: red; text-align: center; margin-top: 50px;">Ошибка загрузки данных.</h2>';
    }
    
    hideLoading();
}

// Запуск инициализации при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    // showLoading(); // Показываем лоадер, если нужно
    init();
});
</script>

</body>
</html>
