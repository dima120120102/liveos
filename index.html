<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Time Owner</title>
<style>
/* ... (–í–∞—à–∏ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
/* --- –ê–î–ê–ü–¢–ê–¶–ò–Ø –ë–õ–û–ö–ê –ö–û–î–ê --- */
/* (–Ø —É–¥–∞–ª–∏–ª –≤—Å—é —Å–µ–∫—Ü–∏—é <style> –∏–∑ —ç—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, –æ–Ω–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */
</style>
</head>
<body>

<div class="top-controls">
    <button id="saveAllBtn" class="save-all-btn">
        <img src="pictures/save.png" width="16" height="16" alt="Save">
        <span id="saveAllBtnText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ</span>
    </button>
    <div id="accountControl" class="account-control-btn">
        <img src="pictures/account.png" width="16" height="16" alt="Profile">
        <span id="usernameDisplay">–ü—Ä–æ—Ñ–∏–ª—å</span>
    </div>
</div>

<div class="banner">
  <img id="bannerImg" src="pictures/banner.jpg" alt="–ë–∞–Ω–Ω–µ—Ä">
</div>

<div class="main-container">
  <aside class="goals">
    <h2>–ì–æ–¥–æ–≤—ã–µ —Ü–µ–ª–∏</h2>
    <div id="goalsList"></div>
    <div id="addGoalBtn" class="add-goal-btn">Ôºã</div>
  </aside>

<main class="right">
    <div class="top-buttons">
        <button id="createWeekBtn" class="btn create-week">–°–æ–∑–¥–∞—Ç—å –Ω–µ–¥–µ–ª—é</button>
        <button id="openTrashBtn" class="btn open-trash-btn">–û—Ç–∫—Ä—ã—Ç—å –ö–æ—Ä–∑–∏–Ω—É</button>
    </div>

    <div class="top-plan-controls">
        <div class="unassigned-container">
            <div style="color:var(--text-secondary);font-size:13px;">–ù–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –Ω–µ–¥–µ–ª–∏ (–ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)</div>
            <div id="unassignedList" class="unassigned-list"></div>
        </div>

        <div id="trashContainer" class="trash-container">
            <img src="pictures/trash-icon.png" width="30" height="30" alt="Trash" class="trash-icon">
            <div class="trash-label">–ö–æ—Ä–∑–∏–Ω–∞ (—É–¥–∞–ª–µ–Ω–∏–µ)</div>
            <div class="trash-hint">–ü–µ—Ä–µ—Ç–∞—â–∏ –Ω–µ–¥–µ–ª—é —Å—é–¥–∞ –¥–ª—è –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è</div>
        </div>
    </div>
    <div class="months-wrapper">
        <div class="months" id="months"></div>
    </div>
</main>
</div>

<section class="habit-tracker">
    <h2>‚úÖ –¢—Ä–µ–∫–µ—Ä –ü—Ä–∏–≤—ã—á–µ–∫</h2>
    <div class="habit-controls">
        <input type="text" id="newHabitInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É">
        <button id="addHabitBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</button>
        <button id="newDayBtn" class="btn create-week">–ù–æ–≤—ã–π –¥–µ–Ω—å</button>
    </div>
    <div class="habit-table-container" id="habitTableContainer">
        <div class="habit-table-wrapper">
            <table class="habit-table">
                <thead>
                    <tr id="habitHeaderRow">
                        <th>–î–∞—Ç–∞</th>
                        <th class="progress-col">–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–Ω—è</th>
                    </tr>
                </thead>
                <tbody id="habitBody">
                </tbody >
            </table>
        </div>
    </div>
    <button class="toggle-history-btn" id="toggleHabitHistoryBtn" style="display:none;">
        –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é
    </button>
</section>

<section class="mood-tracker">
    <h2>‚ú® –¢—Ä–µ–∫–µ—Ä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</h2>
    <p style="text-align:center;">–ö–∞–∫ —Ç–≤–æ–π –¥–µ–Ω—å?</p>
    <div class="mood-selection">
        <span class="mood-option" data-mood="bad" title="–ü–ª–æ—Ö–æ">üòî</span>
        <span class="mood-option" data-mood="normal" title="–ù–æ—Ä–º–∞–ª—å–Ω–æ">üòê</span>
        <span class="mood-option" data-mood="great" title="–û—Ç–ª–∏—á–Ω–æ">üòÑ</span>
    </div>

    <h3>–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</h3>
    <div class="mood-history-controls">
        <select id="moodMonthSelect" class="current-month-select"></select>
    </div>
    <div id="moodCalendar" class="mood-calendar">
        </div>
</section>

<div class="modal" id="weekModal">
    <div class="modal-content week-editor">
        <div class="modal-header">
            <input id="weekTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ–¥–µ–ª–∏">
            <div class="actions">
                <div id="menuContainer" style="position: relative;">
                    <span id="menuBtn">‚ãÆ</span>
                    <div class="menu" id="weekMenu">
                        <div id="deleteWeek"><img src="pictures/trash.png" width="16" alt="–£–¥–∞–ª–∏—Ç—å"> –£–¥–∞–ª–∏—Ç—å –Ω–µ–¥–µ–ª—é</div>
                        <div id="downloadWeek"><img src="pictures/download-icon.png" width="16" alt="–°–∫–∞—á–∞—Ç—å"> –°–∫–∞—á–∞—Ç—å <br> TXT</div>
                    </div>
                </div>
                <span id="closeModal">√ó</span>
            </div>
        </div>
        <div class="modal-body">
            <div class="modal-left">
                <div class="modal-description">
                    <textarea id="weekDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–¥–µ–ª–∏..."></textarea>
                </div>
                <div class="modal-goals">
                    <h4>–ì–æ–¥–æ–≤—ã–µ —Ü–µ–ª–∏</h4>
                    <ul id="modalGoalsList"></ul>
                </div>
            </div>
            <div class="modal-right">
                <div class="modal-days" id="daysContainer"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="save-btn btn" id="saveBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal" id="profileModal">
    <div class="modal-content small-modal-content">
        <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>

        <div class="profile-section">
            <h3>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ù–∏–∫)</h3>
            <div class="profile-input-group">
                <input type="text" id="nickInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫">
                <button id="saveNickBtn" class="btn btn-save-nick">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <div class="profile-section">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º</h3>
            <button id="deleteProfileBtn" class="btn btn-delete">
                <img src="pictures/trash.png" width="16" alt="–£–¥–∞–ª–∏—Ç—å">
                –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
            </button>
            <button id="logoutBtn" class="btn btn-logout">
                <img src="pictures/logout.png" width="16" alt="–í—ã—Ö–æ–¥"> 
                –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
            </button>
        </div>

        <button class="btn" onclick="closeProfileModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div class="modal" id="confirmModal">
    <div class="modal-content small-modal-content confirm-modal-content">
        <h2>‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
        <p id="confirmMessage"></p>

        <div class="confirm-actions">
            <button id="confirmCancelBtn" class="btn btn-logout">–û—Ç–º–µ–Ω–∞</button>
            <button id="confirmDeleteBtn" class="btn btn-delete">–£–¥–∞–ª–∏—Ç—å</button>
        </div>

        <div class="checkbox-group">
            <input type="checkbox" id="dontAskAgain">
            <label for="dontAskAgain">–ë–æ–ª—å—à–µ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏</label>
        </div>
    </div>
</div>


<div id="loadingOverlay">
    <div class="spinner"></div>
    <div>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</div>
</div>

<div id="aiAdviceModalOverlay" class="advice-modal-overlay">
    <div id="aiAdviceModal" class="advice-modal-drawer">
        <div class="advice-drawer-header">
            <h2>ü§ñ AI –°–æ–≤–µ—Ç</h2>
            <button class="advice-drawer-close" onclick="closeAiAdviceModal()">&times;</button>
        </div>
        <div class="advice-drawer-content">
            <p id="aiAdviceText"></p>
        </div>
    </div>
</div>

<div id="aiButtonContainer">
    <button id="getAISuggestionBtn" class="btn">
        ü§ñ –ü–æ–ª—É—á–∏—Ç—å AI —Å–æ–≤–µ—Ç
    </button>
</div>

<footer id="main-footer">
    <div id="particles-js"></div> 

    <div class="footer-content">
        <p>&copy; 2025 dimavenv - —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. –í—Å–µ –ø—Ä–∞–≤–∞ –Ω–∞ Time Owner –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –º–Ω–µ.</p>
        <p>&copy; –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// =================================================================
// 1. –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï (–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–ª—è Supabase)
// =================================================================

// --- –ö–û–ù–°–¢–ê–ù–¢–´ SUPABASE ---
// !!! –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –ó–ù–ê–ß–ï–ù–ò–Ø !!!
const SUPABASE_URL = 'https://dgkozfxuhauemxrbjvno.supabase.co'; 
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRna296Znh1aGF1ZW14cmJqdm5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzOTgzMTcsImV4cCI6MjA3NTk3NDMxN30.kkRJs8IO1cQBnAZe-yBjQs2rXzR34ZV1emQqTG6UqVs'; 
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ Supabase
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- –û–ë–©–ò–ï –ö–û–ù–°–¢–ê–ù–¢–´ (–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –æ—Å—Ç–∞–µ—Ç—Å—è) ---
// SCRIPT_URL –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω!
const STORAGE_KEY_AUTH = 'plannerAuthDataKey'; 
const STORAGE_KEY_USERNAME = 'plannerUsername';
const STORAGE_KEY_LOCAL = 'plannerData_v9_local';
const STORAGE_KEY_UNSAVED = 'plannerUnsavedChanges';
const STORAGE_KEY_CONFIRM_DELETE = 'plannerConfirmDelete_v1';

const months=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
const monthColors=['#d46a6a','#e5b15f','#5fbfd4','#38a386','#d69ce5','#a3d35f','#4dbfa6','#d67fa0','#d6bf5f','#61a0d8','#d68a6a','#6fc07f'];
const weekDays=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
const MOOD_EMOJIS = { bad: 'üòî', normal: 'üòê', great: 'üòÑ' };

let data = null;
let dragId = null;
let dragTitle = null;

const saveAllBtn = document.getElementById('saveAllBtn');
const saveAllBtnText = document.getElementById('saveAllBtnText');
const accountControlBtn = document.getElementById('accountControl');
accountControlBtn.onclick = handleAccountControlClick;

// –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ò–ò
const getAISuggestionBtn = document.getElementById('getAISuggestionBtn');
const aiAdviceModalOverlay = document.getElementById('aiAdviceModalOverlay');
const aiAdviceText = document.getElementById('aiAdviceText');

// –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ö–æ—Ä–∑–∏–Ω—ã
const openTrashBtn = document.getElementById('openTrashBtn');
const trashContainer = document.getElementById('trashContainer');

// –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
const confirmModal = document.getElementById('confirmModal');
const confirmMessage = document.getElementById('confirmMessage');
const confirmCancelBtn = document.getElementById('confirmCancelBtn');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
const dontAskAgainCheckbox = document.getElementById('dontAskAgain');
let currentDeleteResolve = null; 

/* --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–ì–†–£–ó–ö–û–ô (–°–ü–ò–ù–ù–ï–†) --- */
const loadingOverlay = document.getElementById('loadingOverlay');
function showLoading() {
    loadingOverlay.style.display = 'flex';
    setTimeout(() => { loadingOverlay.style.opacity = '1'; }, 10);
}
function hideLoading() {
    loadingOverlay.style.opacity = '0';
    setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
}

/* --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–ï–ú --- */
function setUnsaved(isUnsaved) {
    if (isUnsaved) {
        localStorage.setItem(STORAGE_KEY_UNSAVED, 'true');
        saveAllBtn.classList.add('unsaved');
        // –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ID span
        document.getElementById('saveAllBtnText').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ (!)'; 
    } else {
        localStorage.removeItem(STORAGE_KEY_UNSAVED);
        saveAllBtn.classList.remove('unsaved');
        // –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ID span
        document.getElementById('saveAllBtnText').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ';
    }
}
function save() {
    if (!data) return;
    localStorage.setItem(STORAGE_KEY_LOCAL, JSON.stringify(data));
    setUnsaved(true);
}


// =================================================================
// 2. –§–£–ù–ö–¶–ò–ò –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø –° SUPABASE (–í–ú–ï–°–¢–û APPS SCRIPT)
// =================================================================

/**
 * [–û–ë–ù–û–í–õ–ï–ù–û] –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Supabase.
 */
async function loadDataFromSupabase() {
    const dataKey = localStorage.getItem(STORAGE_KEY_AUTH);
    if (!dataKey) { 
        // –ï—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        window.location.href = 'login.html'; 
        return null; 
    }

    if (localStorage.getItem(STORAGE_KEY_UNSAVED) === 'true') {
        if (!confirm("–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø–æ—Ç–µ—Ä—è—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è? (–û—Ç–º–µ–Ω–∞ - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)")) {
            setUnsaved(true);
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY_LOCAL)); } catch (e) { console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö."); }
        }
    }

    showLoading();

    // 1. SELECT data_json FROM user_data WHERE data_key = '...'
    const { data: result, error } = await supabase
        .from('user_data')
        .select('data_json')
        .eq('data_key', dataKey)
        .single(); // –û–∂–∏–¥–∞–µ–º –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É

    hideLoading();

    if (error && error.code !== 'PGRST116') { // PGRST116: No rows found
        console.error("–û—à–∏–±–∫–∞ Supabase –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:", error);
        alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}.`);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        const emptyData = {goals:[],weeks:{},months:{},unassigned:[],habits:[],habitRecords:[], moodRecords:{}};
        months.forEach(m=>{if(!emptyData.months[m]) emptyData.months[m]=[];});
        return emptyData;
    }

    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏–ª–∏ –ø—Ä–∏—à–µ–ª –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const loadedData = (result && result.data_json) 
        ? result.data_json 
        : {goals:[],weeks:{},months:{},unassigned:[],habits:[],habitRecords:[], moodRecords:{}};

    // –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–æ–ª–µ–π
    if (!loadedData.goals) loadedData.goals = [];
    if (!loadedData.weeks) loadedData.weeks = {};
    if (!loadedData.months) loadedData.months = {};
    if (!loadedData.unassigned) loadedData.unassigned = [];
    if (!loadedData.habits) loadedData.habits = [];
    if (!loadedData.habitRecords) loadedData.habitRecords = [];
    if (!loadedData.moodRecords) loadedData.moodRecords = {};
    months.forEach(m=>{if(!loadedData.months[m]) loadedData.months[m]=[];});

    setUnsaved(false);
    localStorage.setItem(STORAGE_KEY_LOCAL, JSON.stringify(loadedData));
    return loadedData;
}

/**
 * [–û–ë–ù–û–í–õ–ï–ù–û] –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Supabase (UPSERT).
 */
async function saveDataToSupabase() {
    if (!data) return { status: "error", message: "–î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç." };

    localStorage.setItem(STORAGE_KEY_LOCAL, JSON.stringify(data));
    const dataKey = localStorage.getItem(STORAGE_KEY_AUTH);
    if (!dataKey) {
        alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —Å–Ω–æ–≤–∞.");
        window.location.href = 'login.html';
        return { status: "error", message: "–ù–µ—Ç –∫–ª—é—á–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏." };
    }

    showLoading();

    // 2. UPSERT –≤ user_data
    const payload = {
        data_key: dataKey,
        data_json: data, // JSONB –≤ Supabase-JS –ø—Ä–∏–Ω–∏–º–∞–µ—Ç JS-–æ–±—ä–µ–∫—Ç
        updated_at: new Date().toISOString()
    };

    const { error } = await supabase
        .from('user_data')
        .upsert(payload, { onConflict: 'data_key' }); // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ onConflict –¥–ª—è UPSERT

    hideLoading();

    if (error) {
        console.error("–û—à–∏–±–∫–∞ Supabase –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:", error);
        alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`);
        return { status: "error", message: error.message };
    } else {
        setUnsaved(false);
        alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä!");
        return { status: "success" };
    }
}
// –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∫ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ Supabase
saveAllBtn.onclick = saveDataToSupabase;


/**
 * [–û–ë–ù–û–í–õ–ï–ù–û] –ú–µ–Ω—è–µ—Ç –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Supabase.
 */
async function changeUsername(newNick) {
    const dataKey = localStorage.getItem(STORAGE_KEY_AUTH);
    if (!dataKey) { alert("–û—à–∏–±–∫–∞: –Ω–µ—Ç –∫–ª—é—á–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏."); return { status: "error" }; }

    showLoading();
    // 3. UPDATE user_keys SET username = '...' WHERE data_key = '...'
    const { error } = await supabase
        .from('user_keys')
        .update({ username: newNick })
        .eq('data_key', dataKey);

    hideLoading();

    if (error) {
        console.error("–û—à–∏–±–∫–∞ Supabase –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∏–∫–∞:", error);
        let msg = "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∏–∫–∞.";
        if (error.code === '23505') { // –ö–æ–¥ –¥–ª—è –Ω–∞—Ä—É—à–µ–Ω–∏—è UNIQUE-–∫–æ–Ω—Å—Ç—Ä–µ–π–Ω—Ç–∞ (–Ω–∏–∫ –∑–∞–Ω—è—Ç)
            msg = "–û—à–∏–±–∫–∞: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ.";
        }
        alert(msg);
        return { status: "error", message: msg };
    }

    localStorage.setItem(STORAGE_KEY_USERNAME, newNick);
    updateAuthButton();
    alert(`–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${newNick}`);
    closeProfileModal();
    return { status: "success", newUsername: newNick };
}

/**
 * [–û–ë–ù–û–í–õ–ï–ù–û] –£–¥–∞–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ Supabase.
 */
async function deleteProfileAndData() {
    const dataKey = localStorage.getItem(STORAGE_KEY_AUTH);
    const currentUsername = localStorage.getItem(STORAGE_KEY_USERNAME);
    if (!dataKey) { alert("–û—à–∏–±–∫–∞: –Ω–µ—Ç –∫–ª—é—á–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏."); return; }

    if (!confirm("–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –£–î–ê–õ–ò–¢–¨ –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏ –ø—Ä–æ—Ñ–∏–ª—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!")) { return; }
    const confirmText = prompt(`–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –Ω–∏–∫: ${currentUsername}`);
    if (confirmText !== currentUsername) { alert("–í–≤–µ–¥–µ–Ω–Ω—ã–π –Ω–∏–∫ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç. –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."); return; }

    showLoading();
    // 4. DELETE FROM user_keys WHERE data_key = '...'
    // ON DELETE CASCADE –ø–æ–∑–∞–±–æ—Ç–∏—Ç—Å—è –æ–± —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ user_data
    const { error } = await supabase
        .from('user_keys')
        .delete()
        .eq('data_key', dataKey);

    hideLoading();

    if (error) {
        console.error("–û—à–∏–±–∫–∞ Supabase –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", error);
        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è: ${error.message}`);
    } else {
        alert("–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã.");
        ['Auth', 'Username', 'Local', 'Unsaved'].forEach(key => localStorage.removeItem(`planner${key}DataKey`));
        localStorage.removeItem(STORAGE_KEY_CONFIRM_DELETE);
        window.location.href = 'login.html';
    }
}


// =================================================================
// 3. –§–£–ù–ö–¶–ò–ò –õ–ò–ß–ù–û–ì–û –ö–ê–ë–ò–ù–ï–¢–ê (–û—Å—Ç–∞–ª–∏—Å—å –ø–æ—á—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
// =================================================================

const usernameDisplay = document.getElementById('usernameDisplay');
const profileModal = document.getElementById('profileModal');
const nickInput = document.getElementById('nickInput');

function updateAuthButton() {
    const username = localStorage.getItem(STORAGE_KEY_USERNAME);
    usernameDisplay.textContent = username || '–ü—Ä–æ—Ñ–∏–ª—å';
}
function handleAccountControlClick() { openProfileModal(); }
function openProfileModal() {
    nickInput.value = localStorage.getItem(STORAGE_KEY_USERNAME) || '';
    profileModal.style.display='flex';
    setTimeout(()=>profileModal.classList.add('visible'), 10);
}
function closeProfileModal() {
    profileModal.classList.remove('visible');
    setTimeout(() => { profileModal.style.display='none'; }, 300);
}
document.getElementById('saveNickBtn').onclick = async () => {
    const newNick = nickInput.value.trim();
    if (!newNick) { alert("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."); return; }
    if (newNick === localStorage.getItem(STORAGE_KEY_USERNAME)) { closeProfileModal(); return; }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–º–µ–Ω—ã –Ω–∏–∫–∞
    await changeUsername(newNick); 
};
document.getElementById('logoutBtn').onclick = () => {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?")) {
        if (localStorage.getItem(STORAGE_KEY_UNSAVED) === 'true') {
            if (!confirm("–í–Ω–∏–º–∞–Ω–∏–µ! –£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –í—ã–π—Ç–∏ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è?")) return;
        }
        ['Auth', 'Username', 'Local', 'Unsaved'].forEach(key => localStorage.removeItem(`planner${key}DataKey`));
        localStorage.removeItem(STORAGE_KEY_CONFIRM_DELETE);
        window.location.href = 'login.html';
    }
};
document.getElementById('deleteProfileBtn').onclick = deleteProfileAndData;


/* --- –§–£–ù–ö–¶–ò–ò –ö–û–†–ó–ò–ù–´ –ò –£–î–ê–õ–ï–ù–ò–Ø (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
function toggleTrashContainer() {
    const isVisible = trashContainer.classList.contains('visible');
    if (isVisible) {
        trashContainer.classList.remove('visible');
        openTrashBtn.textContent = '–û—Ç–∫—Ä—ã—Ç—å –ö–æ—Ä–∑–∏–Ω—É';
    } else {
        trashContainer.classList.add('visible');
        openTrashBtn.textContent = '–°–∫—Ä—ã—Ç—å –ö–æ—Ä–∑–∏–Ω—É';
    }
}
openTrashBtn.onclick = toggleTrashContainer;
function showConfirmDeleteModal(title) {
    return new Promise(resolve => {
        if (localStorage.getItem(STORAGE_KEY_CONFIRM_DELETE) === 'skip') {
            resolve(true);
            return;
        }
        currentDeleteResolve = resolve;
        confirmMessage.textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç "${title}"?`;
        dontAskAgainCheckbox.checked = false; 
        confirmModal.style.display = 'flex';
        setTimeout(() => confirmModal.classList.add('visible'), 10);
    });
}
function closeConfirmDeleteModal() {
    confirmModal.classList.remove('visible');
    setTimeout(() => { confirmModal.style.display = 'none'; }, 300);
}
confirmDeleteBtn.onclick = () => {
    if (dontAskAgainCheckbox.checked) {
        localStorage.setItem(STORAGE_KEY_CONFIRM_DELETE, 'skip');
    }
    closeConfirmDeleteModal();
    if (currentDeleteResolve) {
        currentDeleteResolve(true);
    }
    currentDeleteResolve = null;
};
confirmCancelBtn.onclick = () => {
    closeConfirmDeleteModal();
    if (currentDeleteResolve) {
        currentDeleteResolve(false);
    }
    currentDeleteResolve = null;
};
trashContainer.ondragover = e => { e.preventDefault(); trashContainer.classList.add('dragover'); };
trashContainer.ondragleave = () => { trashContainer.classList.remove('dragover'); };
trashContainer.ondrop = async e => {
    e.preventDefault(); trashContainer.classList.remove('dragover');
    if (!dragId || !dragTitle) return;
    const confirmed = await showConfirmDeleteModal(dragTitle);

    if (confirmed) {
        let deleted = false;
        const unassignedIndex = data.unassigned.findIndex(w => w.id === dragId);
        if (unassignedIndex !== -1) {
            data.unassigned.splice(unassignedIndex, 1);
            deleted = true;
        }
        if (!deleted) {
            for (const monthName of months) {
                if (data.months[monthName]) {
                    const weekIndex = data.months[monthName].findIndex(w => w.id === dragId);
                    if (weekIndex !== -1) {
                        data.months[monthName].splice(weekIndex, 1);
                        deleted = true;
                        break;
                    }
                }
            }
        }
        if (deleted) {
            save(); 
            renderAll();
        }
    }
    dragId = null;
    dragTitle = null;
};


/* --- –¶–ï–õ–ò, –ù–ï–î–ï–õ–ò, –ú–ï–°–Ø–¶–´ (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
const goalsList=document.getElementById('goalsList');
function renderGoals(){
    goalsList.innerHTML='';
    data.goals.forEach((t,i)=>{
        const div=document.createElement('div'); div.className='goal'; div.contentEditable=true; div.innerText=t;
        div.addEventListener('input',()=> { data.goals[i] = div.innerText.replace(/√ó/g, '').trim(); save(); });
        const rm=document.createElement('span'); rm.className='goal-remove'; rm.innerText='√ó';
        rm.onclick=()=>{data.goals.splice(i,1); save(); renderGoals(); };
        div.appendChild(rm);
        goalsList.appendChild(div);
    });
}
document.getElementById('addGoalBtn').onclick=()=>{data.goals.push('–ù–æ–≤–∞—è —Ü–µ–ª—å');save();renderGoals();};
const unassignedList=document.getElementById('unassignedList');
const createWeekBtn=document.getElementById('createWeekBtn');
const unassignedContainer = unassignedList.parentElement;
unassignedContainer.ondragover = e => { e.preventDefault(); unassignedContainer.classList.add('dragover'); };
unassignedContainer.ondragleave = () => { unassignedContainer.classList.remove('dragover'); };
unassignedContainer.ondrop = e => {
    e.preventDefault(); unassignedContainer.classList.remove('dragover');
    if (!dragId) return;
    for (const monthName of months) {
        if (data.months[monthName]) {
            const weekIndex = data.months[monthName].findIndex(w => w.id === dragId);
            if (weekIndex !== -1) {
                const [weekToMove] = data.months[monthName].splice(weekIndex, 1);
                data.unassigned.push(weekToMove);
                save(); renderAll();
                break;
            }
        }
    }
    dragId = null;
    dragTitle = null;
};
function getWeekById(id) {
    const allWeeks = [...data.unassigned, ...Object.values(data.months).flat()];
    return allWeeks.find(w => w.id === id);
}
function createWeekEl(week){
    const div=document.createElement('div'); div.className='week-item';
    div.innerHTML=`<div>${week.title}</div>`; div.draggable=true;
    div.ondragstart=()=>{
        dragId=week.id;
        dragTitle=week.title;
    };
    div.onclick=()=>openWeekModal(week.id);
    return div;
}
function renderUnassigned(){
    unassignedList.innerHTML='';
    data.unassigned.forEach(w=>{ unassignedList.appendChild(createWeekEl(w)); });
}
const monthsContainer=document.getElementById('months');
function renderMonths(){
    monthsContainer.innerHTML='';
    months.forEach((m,i)=>{
        const div=document.createElement('div'); div.className='month';
        div.style.borderColor=monthColors[i%monthColors.length];
        div.innerHTML=`<div class="m-title">${m}</div><div class="month-weeks"></div><div class="drop-zone" data-month="${m}">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –Ω–µ–¥–µ–ª–∏ —Å—é–¥–∞</div>`;
        monthsContainer.appendChild(div);
        const dropZone=div.querySelector('.drop-zone');
        dropZone.ondragover=e=>{e.preventDefault(); dropZone.classList.add('dragover');};
        dropZone.ondragleave=()=>dropZone.classList.remove('dragover');
        dropZone.ondrop=e=>{
            e.preventDefault(); dropZone.classList.remove('dragover');
            if (!dragId) return;
            const idx=data.unassigned.findIndex(w=>w.id===dragId);
            if(idx>=0){
                const [w] = data.unassigned.splice(idx,1);
                if(!data.months[m]) data.months[m] = [];
                data.months[m].push(w);
                save(); renderAll();
            }
            dragId = null;
            dragTitle = null;
        };
        const monthWeeksDiv=div.querySelector('.month-weeks');
        (data.months[m] || []).forEach(w=>{ monthWeeksDiv.appendChild(createWeekEl(w)); });
    });
}
createWeekBtn.onclick=()=>{
    const week={id:'w'+Date.now(),title:'–ù–æ–≤–∞—è –Ω–µ–¥–µ–ª—è',desc:'',tasks:{}};
    data.unassigned.push(week); save(); renderAll();
};

/* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ù–ï–î–ï–õ–ò (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
const weekModal=document.getElementById('weekModal');
const weekTitle=document.getElementById('weekTitle');
const weekDesc=document.getElementById('weekDesc');
const daysContainer=document.getElementById('daysContainer');
const modalGoalsList=document.getElementById('modalGoalsList');
let currentWeek=null;
function openWeekModal(id){
    const allWeeks=[...data.unassigned, ...Object.values(data.months).flat()];
    currentWeek=allWeeks.find(w=>w.id===id);
    if(!currentWeek) return;
    weekModal.style.display='flex';
    setTimeout(()=>weekModal.classList.add('visible'), 10);
    weekTitle.value=currentWeek.title;
    weekDesc.value=currentWeek.desc || '';
    weekTitle.oninput = () => { currentWeek.title = weekTitle.value; save(); };
    weekDesc.oninput = () => { currentWeek.desc = weekDesc.value; save(); };
    modalGoalsList.innerHTML='';
    data.goals.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; modalGoalsList.appendChild(li); });
    daysContainer.innerHTML='';
    weekDays.forEach(d=>{
        const dayDiv=document.createElement('div'); dayDiv.className='day';
        dayDiv.innerHTML = `<h4>${d} <span>${(currentWeek.tasks[d]||[]).length}</span></h4><div class="tasks"></div><button class="add-task-btn">Ôºã –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>`;
        const taskContainer=dayDiv.querySelector('.tasks');
        (currentWeek.tasks[d]||[]).forEach((t,i)=>{
            const taskDiv=document.createElement('div'); taskDiv.contentEditable=true; taskDiv.innerText=t;
            const rm=document.createElement('img'); rm.src='pictures/trash.png'; rm.className='task-delete';
            rm.onclick=()=>{currentWeek.tasks[d].splice(i,1);renderWeekModal();save();}
            taskDiv.addEventListener('input',()=>{currentWeek.tasks[d][i]=taskDiv.innerText.replace(/√ó/g, '').trim();save();});
            taskDiv.appendChild(rm);
            taskContainer.appendChild(taskDiv);
        });
        dayDiv.querySelector('.add-task-btn').onclick=()=>{
            if(!currentWeek.tasks[d]) currentWeek.tasks[d]=[];
            currentWeek.tasks[d].push('');
            renderWeekModal(); save();
        };
        daysContainer.appendChild(dayDiv);
    });
}
function renderWeekModal(){if(currentWeek) openWeekModal(currentWeek.id);}
function closeWeekModal() {
    weekModal.classList.remove('visible');
    document.getElementById('weekMenu').classList.remove('show');
    setTimeout(() => { weekModal.style.display='none'; }, 300);
}
document.getElementById('closeModal').onclick=()=>closeWeekModal();
document.getElementById('saveBtn').onclick=()=>closeWeekModal();
const menuBtn = document.getElementById('menuBtn');
const weekMenu = document.getElementById('weekMenu');
menuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    weekMenu.classList.toggle('show');
});
document.addEventListener('click', (e) => {
    if (weekMenu.classList.contains('show') && !menuBtn.contains(e.target) && !weekMenu.contains(e.target)) {
        weekMenu.classList.remove('show');
    }
});
document.getElementById('deleteWeek').onclick=async()=>{
    if(!currentWeek) return;
    const weekTitle = currentWeek.title;
    const confirmed = await showConfirmDeleteModal(weekTitle);
    if (confirmed) {
        ['unassigned',...months].forEach(k=>{
            if(k==='unassigned'){data.unassigned=data.unassigned.filter(w=>w.id!==currentWeek.id);}
            else if(data.months[k]) {data.months[k]=data.months[k].filter(w=>w.id!==currentWeek.id);}
        });
        save(); 
        renderAll(); 
        closeWeekModal();
    }
};
document.getElementById('downloadWeek').onclick=()=>{
    if(!currentWeek) return;
    let text=`–ù–∞–∑–≤–∞–Ω–∏–µ: ${currentWeek.title}\n–û–ø–∏—Å–∞–Ω–∏–µ: ${currentWeek.desc || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}\n`;
    weekDays.forEach(d=>{
        text+=`\n${d}:\n`;
        (currentWeek.tasks[d]||[]).forEach((t)=>text+=`  - ${t || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}\n`);
    });
    const blob=new Blob([text],{type:'text/plain;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${currentWeek.title}.txt`; a.click();
};


/* --- –¢–†–ï–ö–ï–† –ü–†–ò–í–´–ß–ï–ö (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
const newHabitInput = document.getElementById('newHabitInput');
const habitTableContainer = document.getElementById('habitTableContainer');
const toggleHabitHistoryBtn = document.getElementById('toggleHabitHistoryBtn');
let isHabitHistoryCollapsed = true;
function renderHabitTracker() {
    habitTableContainer.innerHTML = `<div class="habit-table-wrapper"><table class="habit-table"><thead><tr id="habitHeaderRow"><th>–î–∞—Ç–∞</th></tr></thead><tbody id="habitBody"></tbody></table></div>`;
    const headerRow = document.getElementById('habitHeaderRow');
    const body = document.getElementById('habitBody');
    data.habits.forEach((habit, index) => {
        const th = document.createElement('th');
        const contentDiv = document.createElement('div');
        contentDiv.className = 'habit-header-content';
        const textSpan = document.createElement('span');
        textSpan.contentEditable = true;
        textSpan.innerText = habit;
        textSpan.addEventListener('blur', () => { data.habits[index] = textSpan.innerText.trim(); save(); });
        const removeBtn = document.createElement('span');
        removeBtn.innerText = '√ó';
        removeBtn.className = 'remove-habit';
        removeBtn.title = '–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É';
        removeBtn.onclick = (e) => {
            e.stopPropagation();
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É "${habit}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) {
                data.habits.splice(index, 1);
                data.habitRecords.forEach(record => {
                    if (record.tasks && record.tasks.hasOwnProperty(habit)) {
                        delete record.tasks[habit];
                    }
                });
                save();
                renderHabitTracker();
            }
        };
        contentDiv.appendChild(textSpan);
        contentDiv.appendChild(removeBtn);
        th.appendChild(contentDiv);
        headerRow.appendChild(th);
    });
    const progressTh = document.createElement('th');
    progressTh.className = 'progress-col';
    progressTh.innerText = '–ü—Ä–æ–≥—Ä–µ—Å—Å';
    headerRow.appendChild(progressTh);
    body.innerHTML = '';
    const recordsToShow = isHabitHistoryCollapsed ? data.habitRecords.slice(0, 7) : data.habitRecords;
    recordsToShow.forEach(record => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(record.date).toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit'})}</td>`;
        let completed = 0;
        data.habits.forEach(habit => {
            const td = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = !!(record.tasks && record.tasks[habit]);
            if(checkbox.checked) completed++;
            checkbox.onchange = () => {
                if(!record.tasks) record.tasks = {};
                record.tasks[habit] = checkbox.checked;
                save();
                renderHabitTracker();
            };
            td.appendChild(checkbox);
            tr.appendChild(td);
        });
        const percentage = data.habits.length > 0 ? (completed / data.habits.length) * 100 : 0;
        const progressTd = document.createElement('td');
        progressTd.innerHTML = `<div class="progress-bar-container"><div class="progress-bar" style="width: ${percentage}%;"></div><span class="progress-bar-text">${percentage.toFixed(0)}%</span></div>`;
        tr.appendChild(progressTd);
        body.appendChild(tr);
    });
    toggleHabitHistoryBtn.style.display = data.habitRecords.length > 7 ? 'block' : 'none';
    toggleHabitHistoryBtn.textContent = isHabitHistoryCollapsed ? '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é' : '–°–≤–µ—Ä–Ω—É—Ç—å –∏—Å—Ç–æ—Ä–∏—é';
    habitTableContainer.classList.toggle('collapsed', isHabitHistoryCollapsed && data.habitRecords.length > 7);
}
toggleHabitHistoryBtn.onclick = () => { isHabitHistoryCollapsed = !isHabitHistoryCollapsed; renderHabitTracker(); };
document.getElementById('addHabitBtn').onclick=()=>{
    const text=newHabitInput.value.trim();
    if(text && !data.habits.includes(text)){
        data.habits.push(text);
        newHabitInput.value='';
        save(); renderHabitTracker();
    }
};
document.getElementById('newDayBtn').onclick=()=>{
    const today=new Date().setHours(0,0,0,0);
    if(data.habitRecords.some(r=>new Date(r.date).setHours(0,0,0,0)===today)){
        alert('–ó–∞–ø–∏—Å—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.'); return;
    }
    const newRecord={ date: new Date().toISOString(), tasks: {} };
    data.habits.forEach(h=>{newRecord.tasks[h]=false;});
    data.habitRecords.unshift(newRecord);
    save(); renderHabitTracker();
};

/* --- –¢–†–ï–ö–ï–† –ù–ê–°–¢–†–û–ï–ù–ò–Ø (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
const moodMonthSelect = document.getElementById('moodMonthSelect');
const moodCalendar = document.getElementById('moodCalendar');
function getDayKey(date) { return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`; }
function updateMoodSelect() {
    const now = new Date();
    moodMonthSelect.innerHTML = '';
    for (let i = 0; i < 12; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const option = document.createElement('option');
        option.value = `${date.getFullYear()}-${date.getMonth()}`;
        option.textContent = `${months[date.getMonth()]} ${date.getFullYear()}`;
        moodMonthSelect.appendChild(option);
    }
    moodMonthSelect.value = `${now.getFullYear()}-${now.getMonth()}`;
    moodMonthSelect.onchange = renderMoodCalendar;
}
function renderMoodCalendar() {
    moodCalendar.innerHTML = '';
    ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].forEach(day => { moodCalendar.innerHTML += `<div class="mood-calendar-day">${day}</div>`; });
    const [year, month] = moodMonthSelect.value.split('-').map(Number);
    const date = new Date(year, month, 1);
    let firstDay = date.getDay();
    if (firstDay === 0) firstDay = 7;
    for (let i = 1; i < firstDay; i++) { moodCalendar.innerHTML += `<div class="mood-calendar-cell empty"></div>`; }
    while (date.getMonth() === month) {
        const dayKey = getDayKey(date);
        const mood = data.moodRecords[dayKey];
        moodCalendar.innerHTML += `<div class="mood-calendar-cell"><span class="day-number">${date.getDate()}</span><span class="day-mood">${mood ? MOOD_EMOJIS[mood] : ''}</span></div>`;
        date.setDate(date.getDate() + 1);
    }
}
function updateMoodSelection() {
    const todayKey = getDayKey(new Date());
    const savedMood = data.moodRecords[todayKey];
    document.querySelectorAll('.mood-option').forEach(el => {
        el.classList.toggle('selected', savedMood && el.dataset.mood === savedMood);
        el.onclick = () => {
            data.moodRecords[todayKey] = (savedMood === el.dataset.mood) ? undefined : el.dataset.mood;
            save(); updateMoodSelection(); renderMoodCalendar();
        };
    });
}

// =================================================================
// 4. AI –§–£–ù–ö–¶–ò–û–ù–ê–õ (–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø—Ä—è–º–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ)
// =================================================================

/**
 * [–û–ë–ù–û–í–õ–ï–ù–û] –£–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ–º –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ AI-—Å–æ–≤–µ—Ç–∞.
 */
function closeAiAdviceModal() {
    aiAdviceModalOverlay.classList.remove('visible');
    setTimeout(() => { aiAdviceModalOverlay.style.display = 'none'; }, 300);
}
aiAdviceModalOverlay.addEventListener('click', (e) => {
    if (e.target === aiAdviceModalOverlay) {
        closeAiAdviceModal();
    }
});
/**
 * [–û–ë–ù–û–í–õ–ï–ù–û] –£–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ AI-—Å–æ–≤–µ—Ç–∞.
 */
function openAiAdviceModal(suggestion) {
    let htmlSuggestion = suggestion;

    // 1. –ó–∞–≥–æ–ª–æ–≤–∫–∏ (###)
    htmlSuggestion = htmlSuggestion.replace(/^###\s*(.*)$/gm, (match, content) => {
        let emoji = '';
        if (content.includes('üéØ')) emoji = 'üéØ';
        else if (content.includes('‚úÖ')) emoji = '‚úÖ';
        else if (content.includes('‚ú®')) emoji = '‚ú®';
        else if (content.includes('üìÖ')) emoji = 'üìÖ';
        const cleanContent = content.replace(/[\uD800-\uDBFF\uDC00-\uDFFF]/g, '').trim();
        return `<h3>${emoji ? `<span class="emoji">${emoji}</span> ` : ''}${cleanContent}</h3>`;
    });

    // 2. –°–ø–∏—Å–∫–∏ (*)
    htmlSuggestion = htmlSuggestion.split('\n\n').map(block => {
        if (block.startsWith('- ')) {
            const listItems = block.split('\n').map(line => {
                if (line.startsWith('- ')) {
                    const content = line.substring(2).trim();
                    return `<li>${content}</li>`;
                }
                return line; 
            }).join('');
            return `<ul>${listItems}</ul>`;
        }
        return `<p>${block.replace(/\n/g, '<br>')}</p>`; 
    }).join('');

    // 3. –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (**)
    htmlSuggestion = htmlSuggestion.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    aiAdviceText.innerHTML = htmlSuggestion;
    aiAdviceModalOverlay.style.display = 'block';
    setTimeout(() => { aiAdviceModalOverlay.classList.add('visible'); }, 10);
}

/**
 * –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–¥–∏–Ω –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò.
 */
function generateAIPrompt() {
    let prompt = "";
    prompt += "\n\n### üéØ –ì–æ–¥–æ–≤—ã–µ —Ü–µ–ª–∏\n";
    if (data.goals && data.goals.length > 0) {
        data.goals.forEach((goal, i) => { prompt += `- **–¶–µ–ª—å ${i + 1}**: ${goal}\n`; });
    } else {
        prompt += "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.\n";
    }
    prompt += "\n### ‚úÖ –ü—Ä–∏–≤—ã—á–∫–∏ –∏ –∏—Ö –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é\n";
    const recentRecords = data.habitRecords.slice(0, 7);
    if (data.habits && data.habits.length > 0 && recentRecords.length > 0) {
        const habitsStatus = {};
        data.habits.forEach(h => habitsStatus[h] = { total: 0, completed: 0 });
        recentRecords.forEach(record => {
            Object.keys(record.tasks || {}).forEach(habit => {
                if (habitsStatus[habit]) {
                    habitsStatus[habit].total++;
                    if (record.tasks[habit]) { habitsStatus[habit].completed++; }
                }
            });
        });
        Object.keys(habitsStatus).forEach((habit) => {
            const status = habitsStatus[habit];
            const percent = status.total > 0 ? ((status.completed / status.total) * 100).toFixed(0) : 0;
            prompt += `- –ü—Ä–∏–≤—ã—á–∫–∞ **"${habit}"**: –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ${status.completed} –∏–∑ ${status.total} –¥–Ω–µ–π (**${percent}%**)\n`;
        });
    } else {
        prompt += "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ –Ω–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π.\n";
    }
    prompt += "\n### ‚ú® –ó–∞–ø–∏—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π\n";
    const today = new Date();
    let moodReport = '';
    for(let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const dayKey = getDayKey(date);
        const mood = data.moodRecords[dayKey];
        if (mood) {
             moodReport += `- **${date.toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit'})}**: ${MOOD_EMOJIS[mood] || mood}\n`;
        }
    }
    prompt += moodReport || "–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è.\n";
    prompt += "\n### üìÖ –¢–µ–∫—É—â–∏–µ –Ω–µ–¥–µ–ª–∏ –∏ –∑–∞–¥–∞—á–∏\n";
    let weekReport = '';
    const allWeeks = Object.values(data.months).flat().slice(0, 3);
    if (allWeeks.length > 0) {
        allWeeks.forEach(week => {
            weekReport += `--- –ù–µ–¥–µ–ª—è: **${week.title}** ---\n`;
            weekDays.forEach(day => {
                const tasks = week.tasks[day] || [];
                if (tasks.length > 0) {
                    weekReport += `  - ${day}: ${tasks.join('; ')}\n`;
                }
            });
            weekReport += "\n";
        });
    } else {
        weekReport += "–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–µ–¥–µ–ª—å.\n";
    }
    prompt += weekReport;
    prompt += "\n\n**–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∏ –¥–∞–π –æ–¥–∏–Ω –µ–º–∫–∏–π —Å–æ–≤–µ—Ç (–¥–æ 150 —Å–ª–æ–≤) –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –±–∞–ª–∞–Ω—Å–∞ —Ü–µ–ª–µ–π, –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –∑–∞–¥–∞—á. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Markdown (### –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, ** –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ, * –¥–ª—è —Å–ø–∏—Å–∫–æ–≤).**"
    return prompt;
}

/**
 * [–û–ë–ù–û–í–õ–ï–ù–û] –í—ã–∑–æ–≤ Gemini API. –ó–¥–µ—Å—å —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏–±–æ —Å–≤–æ–π –ø—Ä–æ–∫—Å–∏, –ª–∏–±–æ 
 * –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞. –ü–æ—Å–∫–æ–ª—å–∫—É –ø—Ä—è–º–æ–≥–æ API Gemini –∏–∑ –∫–ª–∏–µ–Ω—Ç–∞ 
 * –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ—Ç, –º—ã –æ—Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É –∏ –ø–æ–¥—Å–∫–∞–∑–∫—É.
 */
async function callGeminiAPI(prompt) {
    alert("–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AI-—Å–æ–≤–µ—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ —Å Apps Script.");
    return { status: "error", message: "AI —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –ø—Ä–æ–∫—Å–∏." };
}

// =================================================================
// 5. –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò AI
// =================================================================

getAISuggestionBtn.onclick = async () => {
    const promptText = generateAIPrompt();
    const result = await callGeminiAPI(promptText);

    if (result.status === 'success' && result.suggestion) {
        openAiAdviceModal(result.suggestion);
    } else {
        // –û—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –≤—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è
        // alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–≤–µ—Ç–∞: ${result.message}`);
    }
};


// =================================================================
// 6. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// =================================================================

function renderAll(){
    renderGoals();
    renderUnassigned();
    renderMonths();
    updateMoodSelection();
}
async function init() {
    const authKey = localStorage.getItem(STORAGE_KEY_AUTH);
    if (!authKey) { window.location.href = 'login.html'; return; }

    updateAuthButton();
    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í—ã–∑–æ–≤ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ Supabase
    data = await loadDataFromSupabase(); 

    if (data) {
        renderAll();
        renderHabitTracker();
        updateMoodSelect();
        renderMoodCalendar();
    } else {
        document.body.innerHTML = '<h2 style="color: red; text-align: center; margin-top: 50px;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</h2>';
    }
}
document.addEventListener('DOMContentLoaded', init);
</script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script src="footer.js"></script>

</body>
</html>