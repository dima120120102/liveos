<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ú–æ–∏ –°–ø–∏—Å–∫–∏ (v2) - Time Owner</title>
<link rel="icon" type="image/png" href="pictures/favicon.png">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/drag-drop-touch"></script>

<style>
/* --- –û–ë–©–ò–ï –°–¢–ò–õ–ò (–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –≤–∞—à–µ–≥–æ htd (1).html) --- */
:root {
    --bg-main: #121212;
    --bg-secondary: #1e1e1e;
    --bg-tertiary: #2a2a2a;
    --bg-hover: #333333;
    --border-color: #383838;
    --text-primary: #e0e0e0;
    --text-secondary: #a0a0a0;
    --accent-color: #007bff;
    --accent-hover: #0056b3;
    --danger-color: #e53935;
    --success-color: #4CAF50;
    --warning-color: #FFC107;
    --header-height: 60px;
}
* { box-sizing: border-box; }
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-hover); }
* { scrollbar-color: var(--accent-color) var(--bg-secondary); scrollbar-width: thin; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg-main);
    color: var(--text-primary);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    overflow-x: hidden; 
    animation: fadeIn 0.5s ease-in-out;
}

.btn{
    background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:10px 15px;border-radius:8px;cursor:pointer;font-weight: 600; 
    transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;
}
.btn:hover{ background-color: var(--bg-hover); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
.btn:active { transform: scale(0.98) translateY(0); } 
.btn-primary{background:var(--accent-color);border-color: var(--accent-color);color: #fff;}
.btn-primary:hover{background:var(--accent-hover);border-color: var(--accent-hover);}
.btn-danger{background:var(--danger-color);border-color: var(--danger-color);color: #fff;}
.btn-danger:hover{background:#c32727;}
.btn-success{background:var(--success-color);border-color: var(--success-color);color: #fff;}
.btn-success:hover{background:#3e8e41;}

/* --- –°–¢–ò–õ–ò –®–ê–ü–ö–ò (–£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ) --- */
.top-controls {
    display: flex; align-items: center; justify-content: space-between; gap: 10px; 
    z-index: 10000; width: 100%; padding: 10px 20px;
    background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);
    min-height: var(--header-height);
}
.top-controls-left { display: flex; align-items: center; gap: 8px; }
.top-controls-center {
    display: flex; align-items: center; gap: 10px; font-size: 1.6em; 
    font-weight: bold; color: var(--accent-color);
}
.top-controls-center img { height: 40px; width: 40px; }
.header-btn {
    background: var(--bg-tertiary); color: var(--text-primary); padding: 8px 15px; border-radius: 8px; cursor: pointer;
    font-size: 14px; font-weight: 600; transition: background 0.2s, color 0.2s, transform 0.2s, box-shadow 0.2s ease; 
    border: 1px solid var(--border-color); display: flex; align-items: center; gap: 8px; text-decoration: none;
}
.header-btn:hover { background: var(--accent-color); color: #fff; transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

/* ---
--- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –°–ü–ò–°–ö–û–í (V2) ---
--- */

.lists-container {
    display: flex;
    flex: 1;
    overflow: hidden;
    height: calc(100vh - var(--header-height));
}

/* --- –°–ê–ô–î–ë–ê–† (–ì–ª–∞–≤–Ω—ã–µ —Å–ø–∏—Å–∫–∏) --- */
.list-sidebar {
    width: 300px;
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    padding: 15px;
    gap: 15px;
    flex-shrink: 0;
    overflow-y: auto;
}
.list-sidebar h2 {
    margin: 0; font-size: 1.2em; color: var(--accent-color);
    border-bottom: 1px solid var(--border-color); padding-bottom: 10px;
}
#main-list-container {
    display: flex; flex-direction: column; gap: 8px;
}
.main-list-item {
    padding: 10px 12px;
    background: var(--bg-tertiary);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s, color 0.2s;
    border-left: 4px solid var(--border-color);
    word-break: break-word;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.main-list-item:hover {
    background: var(--bg-hover);
    border-left-color: var(--accent-hover);
}
.main-list-item.active {
    background: var(--accent-color);
    color: #fff;
    border-left-color: var(--warning-color);
    font-weight: 600;
}
.main-list-item .delete-list-btn {
    font-size: 20px; color: var(--text-secondary); cursor: pointer;
    transition: color 0.2s; padding: 0 5px; opacity: 0.5;
}
.main-list-item:hover .delete-list-btn { opacity: 1; }
.main-list-item .delete-list-btn:hover { color: var(--danger-color); }

/* --- –û–°–ù–û–í–ù–û–ô –í–ò–î (–ü–∞–ø–∫–∏ –∏ –≠–ª–µ–º–µ–Ω—Ç—ã) --- */
.list-main-view {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    /* –£–±–∏—Ä–∞–µ–º padding, —á—Ç–æ–±—ã –∏–Ω–ø—É—Ç –ø—Ä–∏–ª–∏–ø –∫ –Ω–∏–∑—É */
}
.list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    padding: 15px 20px;
    border-bottom: 2px solid var(--border-color);
    background: var(--bg-secondary);
    flex-shrink: 0;
}
.list-header h1 {
    margin: 0;
    font-size: 1.8em;
    color: var(--text-primary);
    word-break: break-word;
}
.list-header-controls { display: flex; gap: 10px; }
.list-header-controls .btn { flex-shrink: 0; }

#list-content-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}
/* --- –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–ø–æ–∫ --- */
.folder-container {
    background: var(--bg-tertiary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    margin-bottom: 15px;
    transition: box-shadow 0.2s;
}
.folder-container.drag-over {
    box-shadow: 0 0 15px var(--accent-color);
    border-color: var(--accent-color);
}
.folder-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    background: var(--bg-hover);
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid var(--border-color);
}
.folder-header h3 {
    margin: 0;
    font-size: 1.1em;
    flex: 1;
    word-break: break-word;
}
.folder-header .folder-delete-btn {
    font-size: 20px; color: var(--text-secondary); cursor: pointer;
    transition: color 0.2s; padding: 0 5px;
}
.folder-header .folder-delete-btn:hover { color: var(--danger-color); }
.folder-items-list {
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-height: 20px; /* –î–ª—è drag-and-drop */
}

/* --- –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–±–µ–∑ –ø–∞–ø–∫–∏) --- */
.root-items-container {
    padding: 10px;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    min-height: 50px; /* –î–ª—è drag-and-drop */
    transition: box-shadow 0.2s;
}
.root-items-container.drag-over {
    box-shadow: 0 0 15px var(--warning-color);
    border-color: var(--warning-color);
}
.root-items-container h3 {
    margin-top: 0;
    margin-bottom: 10px;
    color: var(--text-secondary);
    font-size: 1em;
    border-bottom: 1px dashed var(--border-color);
    padding-bottom: 5px;
}


/* --- –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞ --- */
.list-item-entry {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--bg-main);
    padding: 10px 12px;
    border-radius: 8px;
    border-left: 4px solid var(--border-color);
    transition: background 0.2s, opacity 0.2s, box-shadow 0.2s;
    cursor: grab;
}
.list-item-entry.done {
    opacity: 0.6;
    border-left-color: var(--success-color);
}
.list-item-entry.dragging {
    opacity: 0.5;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    cursor: grabbing;
}
.list-item-entry:active {
    cursor: grabbing;
}
.list-item-entry input[type="checkbox"] {
    width: 20px; height: 20px; flex-shrink: 0;
    accent-color: var(--success-color); cursor: pointer; transform: scale(1.1);
}
.list-item-entry .item-text {
    flex: 1;
    font-size: 1.1em;
    word-break: break-word;
}
.list-item-entry.done .item-text { text-decoration: line-through; }
.list-item-entry .item-delete-btn {
    font-size: 24px; color: var(--text-secondary); cursor: pointer;
    transition: color 0.2s; padding: 0 5px;
}
.list-item-entry .item-delete-btn:hover { color: var(--danger-color); }

/* --- –ù–û–í–´–ô –°–¢–ò–õ–¨: –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è "–∞-–ª—è Telegram" --- */
.list-add-form {
    display: flex;
    gap: 10px;
    align-items: center;
    background: var(--bg-secondary);
    padding: 15px 20px;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}
.list-add-form input[type="text"] {
    flex: 1;
    background: var(--bg-main);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 12px 15px;
    border-radius: 24px; /* –î–µ–ª–∞–µ–º –∫—Ä—É–≥–ª—ã–º */
    font-size: 15px;
}
.list-add-form input[type="text"]:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.4);
}
.list-add-form button {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    padding: 0;
    border-radius: 50%; /* –ö—Ä—É–≥–ª–∞—è –∫–Ω–æ–ø–∫–∞ */
    font-size: 24px;
}
.list-add-form .send-icon {
    width: 24px;
    height: 24px;
    fill: currentColor;
    transform: translateX(1px);
}


#welcome-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    height: 100%;
    color: var(--text-secondary);
    font-size: 1.2em;
}
#welcome-message span {
    font-size: 3em;
    margin-bottom: 15px;
}

/* --- –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è --- */
body.public-view .list-sidebar { display: none; }
body.public-view .top-controls { display: none; }
body.public-view .lists-container {
    height: 100vh; /* –ó–∞–Ω–∏–º–∞–µ–º –≤–µ—Å—å —ç–∫—Ä–∞–Ω, —Ç.–∫. –Ω–µ—Ç —à–∞–ø–∫–∏ */
}
body.public-view .list-main-view { padding: 0; }

/* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –û–ë–©–ò–ï –°–¢–ò–õ–ò (–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ) --- */
.modal{
    position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter: blur(5px);
    z-index:100000; display:none;align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.3s ease;
}
.modal.visible { opacity: 1; } 
.modal-content {
    background: var(--bg-main); width: 95%; max-width: 500px;
    border-radius: 12px; display: flex; flex-direction: column;
    overflow: hidden; border: 1px solid var(--border-color);
    transform: scale(0.95); 
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    max-height: 90vh;
}
.modal.visible .modal-content { transform: scale(1); } 
.modal-header{
    display:flex;justify-content:space-between;align-items:center;padding:15px 20px;
    background:var(--bg-secondary);border-bottom:1px solid var(--border-color);
    flex-shrink: 0;
}
.modal-header h2 { margin: 0; font-size: 1.2em; color: var(--accent-color); }
.modal-header span{cursor:pointer;font-size:24px;position:relative; color: var(--text-secondary); transition: color 0.2s;}
.modal-header span:hover { color: var(--accent-color); }
.modal-body{ padding: 20px; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; gap: 15px; }
.modal-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); background: var(--bg-secondary); flex-shrink: 0; display: flex; justify-content: flex-end; gap: 10px; }

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" */
#share-link-input {
    width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-color);
    color: var(--text-primary); padding: 10px 12px; border-radius: 6px; font-size: 14px;
}
.share-info { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }

/* --- –ê–ù–ò–ú–ê–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò (–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ) --- */
#loadingOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; 
    flex-direction: column; justify-content: center; align-items: center; color: var(--text-primary); font-size: 1.2em;
    z-index: 100001; opacity: 0; transition: opacity 0.3s ease;
}
.spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid var(--accent-color); width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ) --- */
#notification-container {
    position: fixed; top: 80px; right: 20px; z-index: 100001;
    display: flex; flex-direction: column; gap: 10px;
}
.custom-notification {
    background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color);
    border-left: 5px solid var(--warning-color); border-radius: 8px; padding: 15px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; justify-content: space-between;
    align-items: center; gap: 15px; width: 350px; max-width: 90vw; opacity: 0;
    transform: translateX(100%); transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.custom-notification.show { opacity: 1; transform: translateX(0); }
.custom-notification.success { border-left-color: var(--success-color); }
.custom-notification.error { border-left-color: var(--danger-color); }
.custom-notification p { margin: 0; line-height: 1.4; word-break: break-word; }
.custom-notification .close-btn {
    font-size: 24px; color: var(--text-secondary); cursor: pointer;
    background: none; border: none; padding: 0 5px; line-height: 1;
}
.custom-notification .close-btn:hover { color: var(--text-primary); }

/* --- –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ --- */
@media (max-width: 768px) {
    .list-sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        height: auto;
        max-height: 100vh;
        overflow-y: auto;
    }
    .lists-container {
        flex-direction: column;
        height: auto;
    }
    /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å–ø–∏—Å–æ–∫ */
    .lists-container.list-selected .list-sidebar { display: none; }
    /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –≤–∏–¥, –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω */
    .lists-container:not(.list-selected) .list-main-view { display: none; }
    
    .list-main-view { padding: 0; }
    .list-header { padding: 10px 15px; }
    .list-header h1 { font-size: 1.4em; }
    #list-content-area { padding: 10px; }
    
    /* –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    #back-to-lists-btn { display: flex; }
    
    .list-add-form { padding: 10px 15px; }
    .list-add-form button { width: 44px; height: 44px; }
    .list-add-form input[type="text"] { padding: 10px 15px; }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º —à–∞–ø–∫—É –≤ –ø—É–±–ª–∏—á–Ω–æ–º —Ä–µ–∂–∏–º–µ */
    body.public-view .top-controls { display: none; }
}
</style>
</head>

<body>

<div id="notification-container"></div>
<div id="loadingOverlay">
    <div class="spinner"></div>
    <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="top-controls">
    <div class="top-controls-left">
        <a href="htd (1).html" class="header-btn">
            <span>‚Äπ</span>
            <span>–í –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</span>
        </a>
    </div>

    <div class="top-controls-center">
        <img src="pictures/favicon.png" alt="Logo">
        <span>–ú–æ–∏ –°–ø–∏—Å–∫–∏</span>
    </div>
    
    <div class="top-controls-right">
        <button class="btn" id="back-to-lists-btn" style="display: none;">
            <span>‚Äπ</span>
            <span>–ö –°–ø–∏—Å–∫–∞–º</span>
        </button>
    </div>
</div>

<div class="lists-container" id="lists-container">

    <aside class="list-sidebar" id="list-sidebar">
        <h2>–ú–æ–∏ —Å–ø–∏—Å–∫–∏</h2>
        <button class="btn btn-primary" id="new-list-btn">
            <span>Ôºã</span>
            <span>–ù–æ–≤—ã–π —Å–ø–∏—Å–æ–∫</span>
        </button>
        
        <div id="main-list-container">
            </div>
    </aside>

    <main class="list-main-view" id="list-main-view">
        
        <div id="welcome-message">
            <span>üìù</span>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∏–∑ –º–µ–Ω—é —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.<br>–ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫.</p>
        </div>

        <div id="list-content-wrapper" style="display: none; height: 100%; display: flex; flex-direction: column; overflow: hidden;">
            
            <div class="list-header">
                <h1 id="list-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞</h1>
                <div class="list-header-controls">
                    <button class="btn" id="list-new-folder-btn">–ù–æ–≤–∞—è –ø–∞–ø–∫–∞</button>
                    <button class="btn btn-success" id="list-share-btn">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                </div>
            </div>

            <div id="list-content-area">
                </div>

            <form class="list-add-form" id="list-add-form">
                <input type="text" id="new-item-text" placeholder="–ù–æ–≤—ã–π –ø—É–Ω–∫—Ç..." required>
                <button type="submit" class="btn btn-primary" title="–î–æ–±–∞–≤–∏—Ç—å">
                    <svg class="send-icon" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                    </svg>
                </button>
            </form>
        </div>

    </main>
</div>

<div class="modal" id="share-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –°–ø–∏—Å–∫–æ–º</h2>
            <span id="close-share-modal">√ó</span>
        </div>
        <div class="modal-body">
            <p class="share-info">
                –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–µ –∫–æ–º—É —É–≥–æ–¥–Ω–æ.
                <strong>–õ—é–±–æ–π</strong>, —É –∫–æ–≥–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞, —Å–º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏ **—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å** —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫, –¥–∞–∂–µ –±–µ–∑ –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É.
            </p>
            <input type="text" id="share-link-input" readonly>
            <button class="btn btn-primary" id="copy-share-link-btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            <hr style="border-color: var(--border-color); margin: 15px 0;">
            <p class->–î–æ—Å—Ç—É–ø</p>
            <button class="btn btn-danger" id="disable-sharing-btn">
                –û—Ç–∫–ª—é—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø
            </button>
        </div>
    </div>
</div>


<script>
// =================================================================
// 1. –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// =================================================================

// --- –ö–û–ù–°–¢–ê–ù–¢–´ SUPABASE (–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏) ---
const SUPABASE_URL = 'https://dgkozfxuhauemxrbjvno.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRna296Znh1aGF1ZW14cmJqdm5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzOTgzMTcsImV4cCI6MjA3NTk3NDMxN30.kkRJs8IO1cQBnAZe-yBjQs2rXzR34ZV1emQqTG6UqVs';

let supabase = null;
let currentUserId = null;
let currentList = null; // {id, name, is_public_editable, ...}
let currentListFolders = []; // [{id, name, ...}]
let currentListItems = []; // [{id, content, is_done, folder_id, ...}]
let allUserLists = []; // [{id, name, ...}]

// --- DOM –≠–ª–µ–º–µ–Ω—Ç—ã ---
const loadingOverlay = document.getElementById('loadingOverlay');
const container = document.getElementById('lists-container');
const sidebar = document.getElementById('list-sidebar');
const mainView = document.getElementById('list-main-view');
const mainListContainer = document.getElementById('main-list-container');
const welcomeMessage = document.getElementById('welcome-message');
const listContentWrapper = document.getElementById('list-content-wrapper');
const listTitle = document.getElementById('list-title');
const listContentArea = document.getElementById('list-content-area');
const listAddForm = document.getElementById('list-add-form');
const newItemText = document.getElementById('new-item-text');
const backToListsBtn = document.getElementById('back-to-lists-btn');

const shareModal = document.getElementById('share-modal');
const shareLinkInput = document.getElementById('share-link-input');

// --- Drag & Drop State ---
let draggedItem = null;

// =================================================================
// 2. UI –•–ï–õ–ü–ï–†–´ (–ó–∞–≥—Ä—É–∑–∫–∞, –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
// =================================================================

function showLoading() {
    loadingOverlay.style.display = 'flex';
    setTimeout(() => { loadingOverlay.style.opacity = '1'; }, 10);
}
function hideLoading() {
    loadingOverlay.style.opacity = '0';
    setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
}

function showNotification(message, type = 'warning', duration = 5000) {
    const container = document.getElementById('notification-container');
    if (!container) return;
    const notif = document.createElement('div');
    notif.className = `custom-notification ${type}`;
    notif.innerHTML = `<p>${message}</p><button class="close-btn">&times;</button>`;
    container.appendChild(notif);
    setTimeout(() => { notif.classList.add('show'); }, 10);
    
    const removeNotif = () => {
        notif.classList.remove('show');
        setTimeout(() => { if (notif.parentElement) notif.parentElement.removeChild(notif); }, 500);
    };
    notif.querySelector('.close-btn').onclick = removeNotif;
    if (duration) setTimeout(removeNotif, duration);
}

// =================================================================
// 3. –õ–û–ì–ò–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò
// =================================================================

document.addEventListener('DOMContentLoaded', () => {
    if (window.supabase) {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        console.error("Supabase library not found.");
        return;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const shareToken = urlParams.get('id');

    if (shareToken) {
        document.body.classList.add('public-view');
        loadPublicList(shareToken);
    } else {
        checkAuth();
        setupEventListeners();
    }
});

function checkAuth() {
    supabase.auth.onAuthStateChange(async (event, session) => {
        if (session && session.user) {
            currentUserId = session.user.id;
            await loadUserDashboard();
        } else {
            window.location.href = 'login.html';
        }
    });
}

// =================================================================
// 4. –†–ï–ñ–ò–ú –õ–ò–ß–ù–û–ì–û –ö–ê–ë–ò–ù–ï–¢–ê
// =================================================================

async function loadUserDashboard() {
    showLoading();
    const { data: lists, error } = await supabase
        .from('shared_lists')
        .select('*')
        .eq('owner_id', currentUserId)
        .order('created_at');
    
    if (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–æ–≤:", error);
        hideLoading();
        return;
    }
    allUserLists = lists;
    renderSidebar();
    hideLoading();
}

function renderSidebar() {
    mainListContainer.innerHTML = '';
    allUserLists.forEach(list => {
        const listEl = document.createElement('div');
        listEl.className = 'main-list-item';
        listEl.dataset.listId = list.id;
        
        const listNameSpan = document.createElement('span');
        listNameSpan.textContent = list.name;
        listEl.appendChild(listNameSpan);
        
        const deleteBtn = document.createElement('span');
        deleteBtn.className = 'delete-list-btn';
        deleteBtn.innerHTML = '&times;';
        deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å —Å–ø–∏—Å–æ–∫';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            handleDeleteList(list.id, list.name);
        };
        listEl.appendChild(deleteBtn);
        
        if (currentList && list.id === currentList.id) {
            listEl.classList.add('active');
        }
        
        listEl.onclick = () => {
            loadListContent(list.id);
        };
        mainListContainer.appendChild(listEl);
    });
}

async function loadListContent(listId) {
    showLoading();
    
    // 1. –ü–æ–ª—É—á–∞–µ–º —Å–∞–º —Å–ø–∏—Å–æ–∫
    const { data: listData, error: listError } = await supabase
        .from('shared_lists')
        .select('*')
        .eq('id', listId)
        .single();
    
    if (listError) {
        showNotification('–û—à–∏–±–∫–∞: ' + listError.message, 'error');
        hideLoading();
        return;
    }
    currentList = listData;

    // 2. –ü–æ–ª—É—á–∞–µ–º –ø–∞–ø–∫–∏
    const { data: foldersData, error: foldersError } = await supabase
        .from('list_folders')
        .select('*')
        .eq('list_id', listId)
        .order('created_at');
        
    if (foldersError) {
        showNotification('–û—à–∏–±–∫–∞: ' + foldersError.message, 'error');
        hideLoading();
        return;
    }
    currentListFolders = foldersData;
    
    // 3. –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
    const { data: itemsData, error: itemsError } = await supabase
        .from('list_items')
        .select('*')
        .eq('list_id', listId)
        .order('created_at');
        
    if (itemsError) {
        showNotification('–û—à–∏–±–∫–∞: ' itemsError.message, 'error');
        hideLoading();
        return;
    }
    currentListItems = itemsData;
    
    // 4. –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ
    renderSidebar(); // –û–±–Ω–æ–≤–∏—Ç—å active
    renderMainView();
    
    // –ú–æ–±–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
    if (window.innerWidth <= 768) {
        container.classList.add('list-selected');
        backToListsBtn.style.display = 'flex';
    }
    
    hideLoading();
}

function renderMainView() {
    welcomeMessage.style.display = 'none';
    listContentWrapper.style.display = 'flex';
    listTitle.textContent = currentList.name;

    const shareBtn = document.getElementById('list-share-btn');
    shareBtn.textContent = currentList.is_public_editable ? '–î–æ—Å—Ç—É–ø (–í–∫–ª)' : '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è';
    shareBtn.classList.toggle('btn-success', !currentList.is_public_editable);
    
    listContentArea.innerHTML = ''; // –û—á–∏—â–∞–µ–º
    
    // –†–µ–Ω–¥–µ—Ä–∏–º –ø–∞–ø–∫–∏
    currentListFolders.forEach(folder => {
        const folderEl = createFolderElement(folder);
        const itemsInFolder = currentListItems.filter(item => item.folder_id === folder.id);
        const folderItemsList = folderEl.querySelector('.folder-items-list');
        
        itemsInFolder.forEach(item => {
            folderItemsList.appendChild(createItemElement(item));
        });
        listContentArea.appendChild(folderEl);
    });
    
    // –†–µ–Ω–¥–µ—Ä–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã –±–µ–∑ –ø–∞–ø–∫–∏
    const rootItems = currentListItems.filter(item => !item.folder_id);
    const rootContainer = document.createElement('div');
    rootContainer.className = 'root-items-container';
    rootContainer.dataset.folderId = 'null'; // 'null' –∫–∞–∫ ID –¥–ª—è –∫–æ—Ä–Ω—è
    rootContainer.innerHTML = '<h3>–ë–µ–∑ –ø–∞–ø–∫–∏</h3>';
    
    rootItems.forEach(item => {
        rootContainer.appendChild(createItemElement(item));
    });
    listContentArea.appendChild(rootContainer);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ drag-and-drop
    setupDragAndDropListeners();
}

function createFolderElement(folder) {
    const folderEl = document.createElement('div');
    folderEl.className = 'folder-container';
    folderEl.dataset.folderId = folder.id;
    
    folderEl.innerHTML = `
        <div class="folder-header">
            <h3>${folder.name}</h3>
            <span class="folder-delete-btn" title="–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É">&times;</span>
        </div>
        <div class="folder-items-list">
            </div>
    `;
    
    folderEl.querySelector('.folder-delete-btn').onclick = (e) => {
        e.stopPropagation();
        handleDeleteFolder(folder.id, folder.name);
    };
    
    return folderEl;
}

function createItemElement(item) {
    const itemEl = document.createElement('div');
    itemEl.className = 'list-item-entry';
    itemEl.dataset.itemId = item.id;
    itemEl.draggable = true; // –í–∫–ª—é—á–∞–µ–º drag
    
    if (item.is_done) {
        itemEl.classList.add('done');
    }

    itemEl.innerHTML = `
        <input type="checkbox" ${item.is_done ? 'checked' : ''}>
        <span class="item-text">${item.content}</span>
        <span class="item-delete-btn" title="–£–¥–∞–ª–∏—Ç—å –ø—É–Ω–∫—Ç">&times;</span>
    `;

    itemEl.querySelector('input[type="checkbox"]').onchange = (e) => handleToggleItem(item.id, e.target.checked);
    itemEl.querySelector('.item-delete-btn').onclick = () => handleDeleteItem(item.id);
    
    // –°–ª—É—à–∞—Ç–µ–ª–∏ drag –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞
    itemEl.ondragstart = (e) => {
        draggedItem = itemEl;
        setTimeout(() => itemEl.classList.add('dragging'), 0);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', item.id);
    };
    
    itemEl.ondragend = () => {
        draggedItem.classList.remove('dragging');
        draggedItem = null;
    };

    return itemEl;
}

// =================================================================
// 5. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–ï–ô–°–¢–í–ò–ô (CRUD)
// =================================================================

function setupEventListeners() {
    // --- –°–∞–π–¥–±–∞—Ä ---
    document.getElementById('new-list-btn').onclick = handleNewList;
    
    // --- –ì–ª–∞–≤–Ω—ã–π –≤–∏–¥ ---
    listAddForm.onsubmit = (e) => {
        e.preventDefault();
        handleAddItem();
    };
    document.getElementById('list-new-folder-btn').onclick = handleNewFolderInList;
    
    // --- –®–∞–ø–∫–∞ (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö) ---
    backToListsBtn.onclick = () => {
        container.classList.remove('list-selected');
        backToListsBtn.style.display = 'none';
        currentList = null;
        renderSidebar(); // –û–±–Ω–æ–≤–∏—Ç—å active
    };
    
    // --- –ú–æ–¥–∞–ª–∫–∞ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" ---
    document.getElementById('list-share-btn').onclick = openShareModal;
    document.getElementById('close-share-modal').onclick = closeShareModal;
    document.getElementById('copy-share-link-btn').onclick = copyShareLink;
    document.getElementById('disable-sharing-btn').onclick = disableSharing;
    shareModal.onclick = (e) => {
        if (e.target === shareModal) closeShareModal();
    };
}

async function handleNewList() {
    const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–Ω-—Ä, '–ü–æ—Ö–æ–¥'):");
    if (!name || !currentUserId) return;

    showLoading();
    const { data, error } = await supabase
        .from('shared_lists')
        .insert({ name: name, owner_id: currentUserId })
        .select()
        .single();
    
    if (error) {
        showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    } else {
        allUserLists.push(data);
        renderSidebar();
        loadListContent(data.id); // –°—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫
        showNotification(`–°–ø–∏—Å–æ–∫ "${name}" —Å–æ–∑–¥–∞–Ω!`, 'success');
    }
    hideLoading();
}

async function handleDeleteList(listId, listName) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–ø–∏—Å–æ–∫ "${listName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ –∏ —É–¥–∞–ª–∏—Ç –í–°–ï –ø–∞–ø–∫–∏ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –Ω–µ–º.`)) return;
    
    showLoading();
    const { error } = await supabase
        .from('shared_lists')
        .delete()
        .eq('id', listId);
        
    if (error) {
        showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    } else {
        allUserLists = allUserLists.filter(l => l.id !== listId);
        currentList = null;
        renderSidebar();
        welcomeMessage.style.display = 'flex';
        listContentWrapper.style.display = 'none';
        container.classList.remove('list-selected');
        backToListsBtn.style.display = 'none';
        showNotification(`–°–ø–∏—Å–æ–∫ "${listName}" —É–¥–∞–ª–µ–Ω.`, 'success');
    }
    hideLoading();
}

async function handleNewFolderInList() {
    if (!currentList) return;
    const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏ (–Ω-—Ä, '–ü—Ä–æ–¥—É–∫—Ç—ã'):");
    if (!name) return;
    
    showLoading();
    const { data, error } = await supabase
        .from('list_folders')
        .insert({ name: name, list_id: currentList.id })
        .select()
        .single();
        
    if (error) {
        showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    } else {
        currentListFolders.push(data);
        renderMainView(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
        showNotification(`–ü–∞–ø–∫–∞ "${name}" —Å–æ–∑–¥–∞–Ω–∞!`, 'success');
    }
    hideLoading();
}

async function handleDeleteFolder(folderId, folderName) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É "${folderName}"? –í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –Ω–µ–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ "–ë–µ–∑ –ø–∞–ø–∫–∏".`)) return;
    
    showLoading();
    // 1. –û–±–Ω—É–ª—è–µ–º folder_id —É –≤—Å–µ—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const { error: updateError } = await supabase
        .from('list_items')
        .update({ folder_id: null })
        .eq('folder_id', folderId);
        
    if (updateError) {
        showNotification('–û—à–∏–±–∫–∞: ' + updateError.message, 'error');
        hideLoading();
        return;
    }

    // 2. –£–¥–∞–ª—è–µ–º —Å–∞–º—É –ø–∞–ø–∫—É
    const { error: deleteError } = await supabase
        .from('list_folders')
        .delete()
        .eq('id', folderId);

    if (deleteError) {
        showNotification('–û—à–∏–±–∫–∞: ' + deleteError.message, 'error');
    } else {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º
        currentListFolders = currentListFolders.filter(f => f.id !== folderId);
        currentListItems.forEach(i => { if (i.folder_id === folderId) i.folder_id = null; });
        renderMainView();
        showNotification(`–ü–∞–ø–∫–∞ "${folderName}" —É–¥–∞–ª–µ–Ω–∞.`, 'success');
    }
    hideLoading();
}

async function handleAddItem() {
    const content = newItemText.value.trim();
    if (!content || !currentList) return;
    
    // –í—Ä–µ–º–µ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ UI (–≤ –∫–æ—Ä–µ–Ω—å)
    const tempId = `temp-${Date.now()}`;
    const tempItem = { id: tempId, content: content, is_done: false, list_id: currentList.id, folder_id: null };
    const itemEl = createItemElement(tempItem);
    itemEl.style.opacity = '0.5';
    document.querySelector('.root-items-container').appendChild(itemEl);
    newItemText.value = '';

    const { data: newItem, error } = await supabase
        .from('list_items')
        .insert({ content: content, list_id: currentList.id, folder_id: null }) // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –∫–æ—Ä–µ–Ω—å
        .select()
        .single();
    
    if (error) {
        showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        itemEl.remove();
    } else {
        itemEl.remove(); // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π
        currentListItems.push(newItem); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–π
        const realItemEl = createItemElement(newItem); // –°–æ–∑–¥–∞–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–π
        document.querySelector('.root-items-container').appendChild(realItemEl);
    }
}

async function handleDeleteItem(itemId) {
    const itemEl = document.querySelector(`.list-item-entry[data-item-id="${itemId}"]`);
    if (itemEl) itemEl.style.opacity = '0.3';

    const { error } = await supabase
        .from('list_items')
        .delete()
        .eq('id', itemId);

    if (error) {
        showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        if (itemEl) itemEl.style.opacity = '1';
    } else {
        if (itemEl) itemEl.remove();
        currentListItems = currentListItems.filter(i => i.id !== itemId);
    }
}

async function handleToggleItem(itemId, isDone) {
    const itemEl = document.querySelector(`.list-item-entry[data-item-id="${itemId}"]`);
    if (itemEl) itemEl.classList.toggle('done', isDone);

    const { error } = await supabase
        .from('list_items')
        .update({ is_done: isDone })
        .eq('id', itemId);

    if (error) {
        showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        if (itemEl) itemEl.classList.toggle('done', !isDone); // –û—Ç–∫–∞—Ç
    } else {
        const item = currentListItems.find(i => i.id === itemId);
        if (item) item.is_done = isDone;
    }
}

// =================================================================
// 6. –õ–û–ì–ò–ö–ê "–ü–û–î–ï–õ–ò–¢–¨–°–Ø"
// =================================================================
// (–≠—Ç–∞ —á–∞—Å—Ç—å –æ—Å—Ç–∞–ª–∞—Å—å –ø–æ—á—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç.–∫. –ª–æ–≥–∏–∫–∞ —Ç–∞ –∂–µ)

async function openShareModal() {
    if (!currentList) return;
    showLoading();
    const { data, error } = await supabase
        .from('shared_lists')
        .update({ is_public_editable: true })
        .eq('id', currentList.id)
        .select('share_token')
        .single();
    hideLoading();
    if (error) { showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error'); return; }

    currentList.is_public_editable = true;
    renderMainView(); // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É

    const shareUrl = `${window.location.origin}${window.location.pathname}?id=${data.share_token}`;
    shareLinkInput.value = shareUrl;
    shareModal.style.display = 'flex';
    setTimeout(() => shareModal.classList.add('visible'), 10);
}

function closeShareModal() {
    shareModal.classList.remove('visible');
    setTimeout(() => { shareModal.style.display = 'none'; }, 300);
}

function copyShareLink() {
    shareLinkInput.select();
    document.execCommand('copy');
    showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
}

async function disableSharing() {
    if (!currentList) return;
    if (!confirm('–û—Ç–∫–ª—é—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ —Å—Å—ã–ª–∫–µ?')) return;
    showLoading();
    const { error } = await supabase
        .from('shared_lists')
        .update({ is_public_editable: false })
        .eq('id', currentList.id);
    hideLoading();
    if (error) { showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error'); return; }
    
    currentList.is_public_editable = false;
    renderMainView(); // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
    showNotification('–î–æ—Å—Ç—É–ø –ø–æ —Å—Å—ã–ª–∫–µ –æ—Ç–∫–ª—é—á–µ–Ω.', 'success');
    closeShareModal();
}

// =================================================================
// 7. –†–ï–ñ–ò–ú –ü–£–ë–õ–ò–ß–ù–û–ì–û –ü–†–û–°–ú–û–¢–†–ê (–ø–æ ?id=...)
// =================================================================

async function loadPublicList(shareToken) {
    showLoading();
    // 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫, –µ–≥–æ –ø–∞–ø–∫–∏ –∏ –µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç—ã –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
    const { data, error } = await supabase
        .from('shared_lists')
        .select('*, list_folders(*), list_items(*)')
        .eq('share_token', shareToken)
        .eq('is_public_editable', true)
        .single();
        
    hideLoading();
    if (error || !data) {
        console.error("–û—à–∏–±–∫–∞:", error);
        document.body.innerHTML = `<h2 style="color: var(--warning-color); text-align: center; margin-top: 50px;">–°–ø–∏—Å–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç.</h2>`;
        return;
    }
    
    // RLS –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–Ω–æ–Ω–∏–º—É —ç—Ç–æ –¥–µ–ª–∞—Ç—å
    currentList = data;
    currentListFolders = data.list_folders || [];
    currentListItems = data.list_items || [];
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º UI
    renderMainView();
    
    // –°–∫—Ä—ã–≤–∞–µ–º/–æ—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ "–¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞"
    document.getElementById('list-new-folder-btn').style.display = 'none';
    document.getElementById('list-share-btn').style.display = 'none';
    document.querySelectorAll('.folder-delete-btn').forEach(btn => btn.style.display = 'none');
    
    // –í–∫–ª—é—á–∞–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    listAddForm.onsubmit = (e) => {
        e.preventDefault();
        handleAddItem(); // –ë—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑-–∑–∞ RLS
    };
    
    // –í–∫–ª—é—á–∞–µ–º Drag-and-Drop
    setupDragAndDropListeners();
}

// =================================================================
// 8. –õ–û–ì–ò–ö–ê DRAG & DROP
// =================================================================

function setupDragAndDropListeners() {
    const dropZones = document.querySelectorAll('.folder-container, .root-items-container');
    
    dropZones.forEach(zone => {
        zone.ondragover = (e) => {
            e.preventDefault();
            zone.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
        };
        
        zone.ondragleave = () => {
            zone.classList.remove('drag-over');
        };
        
        zone.ondrop = (e) => {
            e.preventDefault();
            zone.classList.remove('drag-over');
            if (!draggedItem) return;
            
            const itemId = draggedItem.dataset.itemId;
            let newFolderId = zone.dataset.folderId; // 'null' –¥–ª—è –∫–æ—Ä–Ω—è
            if (newFolderId === 'null') newFolderId = null; 
            
            // 1. –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ DOM
            const targetList = zone.querySelector('.folder-items-list') || zone;
            targetList.appendChild(draggedItem);
            
            // 2. –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
            updateItemFolder(itemId, newFolderId);
        };
    });
}

async function updateItemFolder(itemId, newFolderId) {
    draggedItem.style.opacity = '0.5'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–æ–±—Ä–∞–±–æ—Ç–∫—É"
    
    const { error } = await supabase
        .from('list_items')
        .update({ folder_id: newFolderId })
        .eq('id', itemId);
        
    if (error) {
        showNotification('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è: ' + error.message, 'error');
        // –¢—É—Ç –Ω—É–∂–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ—Ç–∫–∞—Ç–∞, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º
        loadListContent(currentList.id);
    } else {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
        const item = currentListItems.find(i => i.id === itemId);
        if (item) item.folder_id = newFolderId;
        draggedItem.style.opacity = '1';
        showNotification('–≠–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω!', 'success', 2000);
    }
}

</script>

</body>
</html>
