<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Мои Списки (v2) - Time Owner</title>
<link rel="icon" type="image/png" href="pictures/favicon.png">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/drag-drop-touch"></script>

<style>
/* --- ОБЩИЕ СТИЛИ (Скопированы из вашего htd (1).html) --- */
:root {
    --bg-main: #121212;
    --bg-secondary: #1e1e1e;
    --bg-tertiary: #2a2a2a;
    --bg-hover: #333333;
    --border-color: #383838;
    --text-primary: #e0e0e0;
    --text-secondary: #a0a0a0;
    --accent-color: #007bff;
    --accent-hover: #0056b3;
    --danger-color: #e53935;
    --success-color: #4CAF50;
    --warning-color: #FFC107;
    --header-height: 60px;
}
* { box-sizing: border-box; }
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-hover); }
* { scrollbar-color: var(--accent-color) var(--bg-secondary); scrollbar-width: thin; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg-main);
    color: var(--text-primary);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    overflow-x: hidden; 
    animation: fadeIn 0.5s ease-in-out;
}

.btn{
    background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:10px 15px;border-radius:8px;cursor:pointer;font-weight: 600; 
    transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;
}
.btn:hover{ background-color: var(--bg-hover); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
.btn:active { transform: scale(0.98) translateY(0); } 
.btn-primary{background:var(--accent-color);border-color: var(--accent-color);color: #fff;}
.btn-primary:hover{background:var(--accent-hover);border-color: var(--accent-hover);}
.btn-danger{background:var(--danger-color);border-color: var(--danger-color);color: #fff;}
.btn-danger:hover{background:#c32727;}
.btn-success{background:var(--success-color);border-color: var(--success-color);color: #fff;}
.btn-success:hover{background:#3e8e41;}

/* --- СТИЛИ ШАПКИ (Упрощенные) --- */
.top-controls {
    display: flex; align-items: center; justify-content: space-between; gap: 10px; 
    z-index: 10000; width: 100%; padding: 10px 20px;
    background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);
    min-height: var(--header-height);
}
.top-controls-left { display: flex; align-items: center; gap: 8px; }
.top-controls-center {
    display: flex; align-items: center; gap: 10px; font-size: 1.6em; 
    font-weight: bold; color: var(--accent-color);
}
.top-controls-center img { height: 40px; width: 40px; }
.header-btn {
    background: var(--bg-tertiary); color: var(--text-primary); padding: 8px 15px; border-radius: 8px; cursor: pointer;
    font-size: 14px; font-weight: 600; transition: background 0.2s, color 0.2s, transform 0.2s, box-shadow 0.2s ease; 
    border: 1px solid var(--border-color); display: flex; align-items: center; gap: 8px; text-decoration: none;
}
.header-btn:hover { background: var(--accent-color); color: #fff; transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

/* ---
--- НОВЫЕ СТИЛИ ДЛЯ СТРАНИЦЫ СПИСКОВ (V2) ---
--- */

.lists-container {
    display: flex;
    flex: 1;
    overflow: hidden;
    height: calc(100vh - var(--header-height));
}

/* --- САЙДБАР (Главные списки) --- */
.list-sidebar {
    width: 300px;
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    padding: 15px;
    gap: 15px;
    flex-shrink: 0;
    overflow-y: auto;
}
.list-sidebar h2 {
    margin: 0; font-size: 1.2em; color: var(--accent-color);
    border-bottom: 1px solid var(--border-color); padding-bottom: 10px;
}
#main-list-container {
    display: flex; flex-direction: column; gap: 8px;
}
.main-list-item {
    padding: 10px 12px;
    background: var(--bg-tertiary);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s, color 0.2s;
    border-left: 4px solid var(--border-color);
    word-break: break-word;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.main-list-item:hover {
    background: var(--bg-hover);
    border-left-color: var(--accent-hover);
}
.main-list-item.active {
    background: var(--accent-color);
    color: #fff;
    border-left-color: var(--warning-color);
    font-weight: 600;
}
.main-list-item .delete-list-btn {
    font-size: 20px; color: var(--text-secondary); cursor: pointer;
    transition: color 0.2s; padding: 0 5px; opacity: 0.5;
}
.main-list-item:hover .delete-list-btn { opacity: 1; }
.main-list-item .delete-list-btn:hover { color: var(--danger-color); }

/* --- ОСНОВНОЙ ВИД (Папки и Элементы) --- */
.list-main-view {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    /* Убираем padding, чтобы инпут прилип к низу */
}
.list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    padding: 15px 20px;
    border-bottom: 2px solid var(--border-color);
    background: var(--bg-secondary);
    flex-shrink: 0;
}
.list-header h1 {
    margin: 0;
    font-size: 1.8em;
    color: var(--text-primary);
    word-break: break-word;
}
.list-header-controls { display: flex; gap: 10px; }
.list-header-controls .btn { flex-shrink: 0; }

#list-content-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}
/* --- Стили для папок --- */
.folder-container {
    background: var(--bg-tertiary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    margin-bottom: 15px;
    transition: box-shadow 0.2s;
}
.folder-container.drag-over {
    box-shadow: 0 0 15px var(--accent-color);
    border-color: var(--accent-color);
}
.folder-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    background: var(--bg-hover);
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid var(--border-color);
}
.folder-header h3 {
    margin: 0;
    font-size: 1.1em;
    flex: 1;
    word-break: break-word;
}
.folder-header .folder-delete-btn {
    font-size: 20px; color: var(--text-secondary); cursor: pointer;
    transition: color 0.2s; padding: 0 5px;
}
.folder-header .folder-delete-btn:hover { color: var(--danger-color); }
.folder-items-list {
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-height: 20px; /* Для drag-and-drop */
}

/* --- Стили для корневого списка (без папки) --- */
.root-items-container {
    padding: 10px;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    min-height: 50px; /* Для drag-and-drop */
    transition: box-shadow 0.2s;
}
.root-items-container.drag-over {
    box-shadow: 0 0 15px var(--warning-color);
    border-color: var(--warning-color);
}
.root-items-container h3 {
    margin-top: 0;
    margin-bottom: 10px;
    color: var(--text-secondary);
    font-size: 1em;
    border-bottom: 1px dashed var(--border-color);
    padding-bottom: 5px;
}


/* --- Стили для элементов списка --- */
.list-item-entry {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--bg-main);
    padding: 10px 12px;
    border-radius: 8px;
    border-left: 4px solid var(--border-color);
    transition: background 0.2s, opacity 0.2s, box-shadow 0.2s;
    cursor: grab;
}
.list-item-entry.done {
    opacity: 0.6;
    border-left-color: var(--success-color);
}
.list-item-entry.dragging {
    opacity: 0.5;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    cursor: grabbing;
}
.list-item-entry:active {
    cursor: grabbing;
}
.list-item-entry input[type="checkbox"] {
    width: 20px; height: 20px; flex-shrink: 0;
    accent-color: var(--success-color); cursor: pointer; transform: scale(1.1);
}
.list-item-entry .item-text {
    flex: 1;
    font-size: 1.1em;
    word-break: break-word;
}
.list-item-entry.done .item-text { text-decoration: line-through; }
.list-item-entry .item-delete-btn {
    font-size: 24px; color: var(--text-secondary); cursor: pointer;
    transition: color 0.2s; padding: 0 5px;
}
.list-item-entry .item-delete-btn:hover { color: var(--danger-color); }

/* --- НОВЫЙ СТИЛЬ: Форма добавления "а-ля Telegram" --- */
.list-add-form {
    display: flex;
    gap: 10px;
    align-items: center;
    background: var(--bg-secondary);
    padding: 15px 20px;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}
.list-add-form input[type="text"] {
    flex: 1;
    background: var(--bg-main);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 12px 15px;
    border-radius: 24px; /* Делаем круглым */
    font-size: 15px;
}
.list-add-form input[type="text"]:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.4);
}
.list-add-form button {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    padding: 0;
    border-radius: 50%; /* Круглая кнопка */
    font-size: 24px;
}
.list-add-form .send-icon {
    width: 24px;
    height: 24px;
    fill: currentColor;
    transform: translateX(1px);
}


#welcome-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    height: 100%;
    color: var(--text-secondary);
    font-size: 1.2em;
}
#welcome-message span {
    font-size: 3em;
    margin-bottom: 15px;
}

/* --- Стили для режима публичного просмотра/редактирования --- */
body.public-view .list-sidebar { display: none; }
body.public-view .top-controls { display: none; }
body.public-view .lists-container {
    height: 100vh; /* Занимаем весь экран, т.к. нет шапки */
}
body.public-view .list-main-view { padding: 0; }

/* --- МОДАЛЬНОЕ ОКНО: ОБЩИЕ СТИЛИ (Скопировано) --- */
.modal{
    position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter: blur(5px);
    z-index:100000; display:none;align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.3s ease;
}
.modal.visible { opacity: 1; } 
.modal-content {
    background: var(--bg-main); width: 95%; max-width: 500px;
    border-radius: 12px; display: flex; flex-direction: column;
    overflow: hidden; border: 1px solid var(--border-color);
    transform: scale(0.95); 
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    max-height: 90vh;
}
.modal.visible .modal-content { transform: scale(1); } 
.modal-header{
    display:flex;justify-content:space-between;align-items:center;padding:15px 20px;
    background:var(--bg-secondary);border-bottom:1px solid var(--border-color);
    flex-shrink: 0;
}
.modal-header h2 { margin: 0; font-size: 1.2em; color: var(--accent-color); }
.modal-header span{cursor:pointer;font-size:24px;position:relative; color: var(--text-secondary); transition: color 0.2s;}
.modal-header span:hover { color: var(--accent-color); }
.modal-body{ padding: 20px; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; gap: 15px; }
.modal-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); background: var(--bg-secondary); flex-shrink: 0; display: flex; justify-content: flex-end; gap: 10px; }

/* Стили для модалки "Поделиться" */
#share-link-input {
    width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-color);
    color: var(--text-primary); padding: 10px 12px; border-radius: 6px; font-size: 14px;
}
.share-info { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }

/* --- АНИМАЦИЯ ЗАГРУЗКИ (Скопировано) --- */
#loadingOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; 
    flex-direction: column; justify-content: center; align-items: center; color: var(--text-primary); font-size: 1.2em;
    z-index: 100001; opacity: 0; transition: opacity 0.3s ease;
}
.spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid var(--accent-color); width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* --- УВЕДОМЛЕНИЯ (Скопировано) --- */
#notification-container {
    position: fixed; top: 80px; right: 20px; z-index: 100001;
    display: flex; flex-direction: column; gap: 10px;
}
.custom-notification {
    background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color);
    border-left: 5px solid var(--warning-color); border-radius: 8px; padding: 15px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; justify-content: space-between;
    align-items: center; gap: 15px; width: 350px; max-width: 90vw; opacity: 0;
    transform: translateX(100%); transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.custom-notification.show { opacity: 1; transform: translateX(0); }
.custom-notification.success { border-left-color: var(--success-color); }
.custom-notification.error { border-left-color: var(--danger-color); }
.custom-notification p { margin: 0; line-height: 1.4; word-break: break-word; }
.custom-notification .close-btn {
    font-size: 24px; color: var(--text-secondary); cursor: pointer;
    background: none; border: none; padding: 0 5px; line-height: 1;
}
.custom-notification .close-btn:hover { color: var(--text-primary); }

/* --- АДАПТИВНОСТЬ --- */
@media (max-width: 768px) {
    .list-sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        height: auto;
        max-height: 100vh;
        overflow-y: auto;
    }
    .lists-container {
        flex-direction: column;
        height: auto;
    }
    /* Скрываем сайдбар, если выбран список */
    .lists-container.list-selected .list-sidebar { display: none; }
    /* Показываем только главный вид, если список выбран */
    .lists-container:not(.list-selected) .list-main-view { display: none; }
    
    .list-main-view { padding: 0; }
    .list-header { padding: 10px 15px; }
    .list-header h1 { font-size: 1.4em; }
    #list-content-area { padding: 10px; }
    
    /* Кнопка "Назад" для мобильных */
    #back-to-lists-btn { display: flex; }
    
    .list-add-form { padding: 10px 15px; }
    .list-add-form button { width: 44px; height: 44px; }
    .list-add-form input[type="text"] { padding: 10px 15px; }
    
    /* Скрываем шапку в публичном режиме */
    body.public-view .top-controls { display: none; }
}
</style>
</head>

<body>

<div id="notification-container"></div>
<div id="loadingOverlay">
    <div class="spinner"></div>
    <div>Загрузка...</div>
</div>

<div class="top-controls">
    <div class="top-controls-left">
        <a href="htd (1).html" class="header-btn">
            <span>‹</span>
            <span>В Планировщик</span>
        </a>
    </div>

    <div class="top-controls-center">
        <img src="pictures/favicon.png" alt="Logo">
        <span>Мои Списки</span>
    </div>
    
    <div class="top-controls-right">
        <button class="btn" id="back-to-lists-btn" style="display: none;">
            <span>‹</span>
            <span>К Спискам</span>
        </button>
    </div>
</div>

<div class="lists-container" id="lists-container">

    <aside class="list-sidebar" id="list-sidebar">
        <h2>Мои списки</h2>
        <button class="btn btn-primary" id="new-list-btn">
            <span>＋</span>
            <span>Новый список</span>
        </button>
        
        <div id="main-list-container">
            </div>
    </aside>

    <main class="list-main-view" id="list-main-view">
        
        <div id="welcome-message">
            <span>📝</span>
            <p>Выберите список из меню слева, чтобы начать.<br>Или создайте новый список.</p>
        </div>

        <div id="list-content-wrapper" style="display: none; height: 100%; display: flex; flex-direction: column; overflow: hidden;">
            
            <div class="list-header">
                <h1 id="list-title">Название списка</h1>
                <div class="list-header-controls">
                    <button class="btn" id="list-new-folder-btn">Новая папка</button>
                    <button class="btn btn-success" id="list-share-btn">Поделиться</button>
                </div>
            </div>

            <div id="list-content-area">
                </div>

            <form class="list-add-form" id="list-add-form">
                <input type="text" id="new-item-text" placeholder="Новый пункт..." required>
                <button type="submit" class="btn btn-primary" title="Добавить">
                    <svg class="send-icon" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                    </svg>
                </button>
            </form>
        </div>

    </main>
</div>

<div class="modal" id="share-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Поделиться Списком</h2>
            <span id="close-share-modal">×</span>
        </div>
        <div class="modal-body">
            <p class="share-info">
                Скопируйте эту ссылку и отправьте ее кому угодно.
                <strong>Любой</strong>, у кого есть ссылка, сможет просматривать и **редактировать** этот список, даже без входа в систему.
            </p>
            <input type="text" id="share-link-input" readonly>
            <button class="btn btn-primary" id="copy-share-link-btn">Копировать ссылку</button>
            <hr style="border-color: var(--border-color); margin: 15px 0;">
            <p class->Доступ</p>
            <button class="btn btn-danger" id="disable-sharing-btn">
                Отключить публичный доступ
            </button>
        </div>
    </div>
</div>


<script>
// =================================================================
// 1. КОНСТАНТЫ И ПЕРЕМЕННЫЕ
// =================================================================

// --- КОНСТАНТЫ SUPABASE (Вставьте ваши) ---
const SUPABASE_URL = 'https://dgkozfxuhauemxrbjvno.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRna296Znh1aGF1ZW14cmJqdm5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzOTgzMTcsImV4cCI6MjA3NTk3NDMxN30.kkRJs8IO1cQBnAZe-yBjQs2rXzR34ZV1emQqTG6UqVs';

let supabase = null;
let currentUserId = null;
let currentList = null; // {id, name, is_public_editable, ...}
let currentListFolders = []; // [{id, name, ...}]
let currentListItems = []; // [{id, content, is_done, folder_id, ...}]
let allUserLists = []; // [{id, name, ...}]

// --- DOM Элементы ---
const loadingOverlay = document.getElementById('loadingOverlay');
const container = document.getElementById('lists-container');
const sidebar = document.getElementById('list-sidebar');
const mainView = document.getElementById('list-main-view');
const mainListContainer = document.getElementById('main-list-container');
const welcomeMessage = document.getElementById('welcome-message');
const listContentWrapper = document.getElementById('list-content-wrapper');
const listTitle = document.getElementById('list-title');
const listContentArea = document.getElementById('list-content-area');
const listAddForm = document.getElementById('list-add-form');
const newItemText = document.getElementById('new-item-text');
const backToListsBtn = document.getElementById('back-to-lists-btn');

const shareModal = document.getElementById('share-modal');
const shareLinkInput = document.getElementById('share-link-input');

// --- Drag & Drop State ---
let draggedItem = null;

// =================================================================
// 2. UI ХЕЛПЕРЫ (Загрузка, Уведомления)
// =================================================================

function showLoading() {
    loadingOverlay.style.display = 'flex';
    setTimeout(() => { loadingOverlay.style.opacity = '1'; }, 10);
}
function hideLoading() {
    loadingOverlay.style.opacity = '0';
    setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
}

function showNotification(message, type = 'warning', duration = 5000) {
    const container = document.getElementById('notification-container');
    if (!container) return;
    const notif = document.createElement('div');
    notif.className = `custom-notification ${type}`;
    notif.innerHTML = `<p>${message}</p><button class="close-btn">&times;</button>`;
    container.appendChild(notif);
    setTimeout(() => { notif.classList.add('show'); }, 10);
    
    const removeNotif = () => {
        notif.classList.remove('show');
        setTimeout(() => { if (notif.parentElement) notif.parentElement.removeChild(notif); }, 500);
    };
    notif.querySelector('.close-btn').onclick = removeNotif;
    if (duration) setTimeout(removeNotif, duration);
}

// =================================================================
// 3. ЛОГИКА АВТОРИЗАЦИИ И ИНИЦИАЛИЗАЦИИ
// =================================================================

document.addEventListener('DOMContentLoaded', () => {
    if (window.supabase) {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        console.error("Supabase library not found.");
        return;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const shareToken = urlParams.get('id');

    if (shareToken) {
        document.body.classList.add('public-view');
        loadPublicList(shareToken);
    } else {
        checkAuth();
        setupEventListeners();
    }
});

function checkAuth() {
    supabase.auth.onAuthStateChange(async (event, session) => {
        if (session && session.user) {
            currentUserId = session.user.id;
            await loadUserDashboard();
        } else {
            window.location.href = 'login.html';
        }
    });
}

// =================================================================
// 4. РЕЖИМ ЛИЧНОГО КАБИНЕТА
// =================================================================

async function loadUserDashboard() {
    showLoading();
    const { data: lists, error } = await supabase
        .from('shared_lists')
        .select('*')
        .eq('owner_id', currentUserId)
        .order('created_at');
    
    if (error) {
        console.error("Ошибка загрузки списков:", error);
        hideLoading();
        return;
    }
    allUserLists = lists;
    renderSidebar();
    hideLoading();
}

function renderSidebar() {
    mainListContainer.innerHTML = '';
    allUserLists.forEach(list => {
        const listEl = document.createElement('div');
        listEl.className = 'main-list-item';
        listEl.dataset.listId = list.id;
        
        const listNameSpan = document.createElement('span');
        listNameSpan.textContent = list.name;
        listEl.appendChild(listNameSpan);
        
        const deleteBtn = document.createElement('span');
        deleteBtn.className = 'delete-list-btn';
        deleteBtn.innerHTML = '&times;';
        deleteBtn.title = 'Удалить список';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            handleDeleteList(list.id, list.name);
        };
        listEl.appendChild(deleteBtn);
        
        if (currentList && list.id === currentList.id) {
            listEl.classList.add('active');
        }
        
        listEl.onclick = () => {
            loadListContent(list.id);
        };
        mainListContainer.appendChild(listEl);
    });
}

async function loadListContent(listId) {
    showLoading();
    
    // 1. Получаем сам список
    const { data: listData, error: listError } = await supabase
        .from('shared_lists')
        .select('*')
        .eq('id', listId)
        .single();
    
    if (listError) {
        showNotification('Ошибка: ' + listError.message, 'error');
        hideLoading();
        return;
    }
    currentList = listData;

    // 2. Получаем папки
    const { data: foldersData, error: foldersError } = await supabase
        .from('list_folders')
        .select('*')
        .eq('list_id', listId)
        .order('created_at');
        
    if (foldersError) {
        showNotification('Ошибка: ' + foldersError.message, 'error');
        hideLoading();
        return;
    }
    currentListFolders = foldersData;
    
    // 3. Получаем элементы
    const { data: itemsData, error: itemsError } = await supabase
        .from('list_items')
        .select('*')
        .eq('list_id', listId)
        .order('created_at');
        
    if (itemsError) {
        showNotification('Ошибка: ' itemsError.message, 'error');
        hideLoading();
        return;
    }
    currentListItems = itemsData;
    
    // 4. Рендерим все
    renderSidebar(); // Обновить active
    renderMainView();
    
    // Мобильная логика
    if (window.innerWidth <= 768) {
        container.classList.add('list-selected');
        backToListsBtn.style.display = 'flex';
    }
    
    hideLoading();
}

function renderMainView() {
    welcomeMessage.style.display = 'none';
    listContentWrapper.style.display = 'flex';
    listTitle.textContent = currentList.name;

    const shareBtn = document.getElementById('list-share-btn');
    shareBtn.textContent = currentList.is_public_editable ? 'Доступ (Вкл)' : 'Поделиться';
    shareBtn.classList.toggle('btn-success', !currentList.is_public_editable);
    
    listContentArea.innerHTML = ''; // Очищаем
    
    // Рендерим папки
    currentListFolders.forEach(folder => {
        const folderEl = createFolderElement(folder);
        const itemsInFolder = currentListItems.filter(item => item.folder_id === folder.id);
        const folderItemsList = folderEl.querySelector('.folder-items-list');
        
        itemsInFolder.forEach(item => {
            folderItemsList.appendChild(createItemElement(item));
        });
        listContentArea.appendChild(folderEl);
    });
    
    // Рендерим элементы без папки
    const rootItems = currentListItems.filter(item => !item.folder_id);
    const rootContainer = document.createElement('div');
    rootContainer.className = 'root-items-container';
    rootContainer.dataset.folderId = 'null'; // 'null' как ID для корня
    rootContainer.innerHTML = '<h3>Без папки</h3>';
    
    rootItems.forEach(item => {
        rootContainer.appendChild(createItemElement(item));
    });
    listContentArea.appendChild(rootContainer);
    
    // Добавляем слушатели drag-and-drop
    setupDragAndDropListeners();
}

function createFolderElement(folder) {
    const folderEl = document.createElement('div');
    folderEl.className = 'folder-container';
    folderEl.dataset.folderId = folder.id;
    
    folderEl.innerHTML = `
        <div class="folder-header">
            <h3>${folder.name}</h3>
            <span class="folder-delete-btn" title="Удалить папку">&times;</span>
        </div>
        <div class="folder-items-list">
            </div>
    `;
    
    folderEl.querySelector('.folder-delete-btn').onclick = (e) => {
        e.stopPropagation();
        handleDeleteFolder(folder.id, folder.name);
    };
    
    return folderEl;
}

function createItemElement(item) {
    const itemEl = document.createElement('div');
    itemEl.className = 'list-item-entry';
    itemEl.dataset.itemId = item.id;
    itemEl.draggable = true; // Включаем drag
    
    if (item.is_done) {
        itemEl.classList.add('done');
    }

    itemEl.innerHTML = `
        <input type="checkbox" ${item.is_done ? 'checked' : ''}>
        <span class="item-text">${item.content}</span>
        <span class="item-delete-btn" title="Удалить пункт">&times;</span>
    `;

    itemEl.querySelector('input[type="checkbox"]').onchange = (e) => handleToggleItem(item.id, e.target.checked);
    itemEl.querySelector('.item-delete-btn').onclick = () => handleDeleteItem(item.id);
    
    // Слушатели drag для элемента
    itemEl.ondragstart = (e) => {
        draggedItem = itemEl;
        setTimeout(() => itemEl.classList.add('dragging'), 0);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', item.id);
    };
    
    itemEl.ondragend = () => {
        draggedItem.classList.remove('dragging');
        draggedItem = null;
    };

    return itemEl;
}

// =================================================================
// 5. ОБРАБОТЧИКИ ДЕЙСТВИЙ (CRUD)
// =================================================================

function setupEventListeners() {
    // --- Сайдбар ---
    document.getElementById('new-list-btn').onclick = handleNewList;
    
    // --- Главный вид ---
    listAddForm.onsubmit = (e) => {
        e.preventDefault();
        handleAddItem();
    };
    document.getElementById('list-new-folder-btn').onclick = handleNewFolderInList;
    
    // --- Шапка (для мобильных) ---
    backToListsBtn.onclick = () => {
        container.classList.remove('list-selected');
        backToListsBtn.style.display = 'none';
        currentList = null;
        renderSidebar(); // Обновить active
    };
    
    // --- Модалка "Поделиться" ---
    document.getElementById('list-share-btn').onclick = openShareModal;
    document.getElementById('close-share-modal').onclick = closeShareModal;
    document.getElementById('copy-share-link-btn').onclick = copyShareLink;
    document.getElementById('disable-sharing-btn').onclick = disableSharing;
    shareModal.onclick = (e) => {
        if (e.target === shareModal) closeShareModal();
    };
}

async function handleNewList() {
    const name = prompt("Введите название нового списка (н-р, 'Поход'):");
    if (!name || !currentUserId) return;

    showLoading();
    const { data, error } = await supabase
        .from('shared_lists')
        .insert({ name: name, owner_id: currentUserId })
        .select()
        .single();
    
    if (error) {
        showNotification('Ошибка: ' + error.message, 'error');
    } else {
        allUserLists.push(data);
        renderSidebar();
        loadListContent(data.id); // Сразу открываем новый список
        showNotification(`Список "${name}" создан!`, 'success');
    }
    hideLoading();
}

async function handleDeleteList(listId, listName) {
    if (!confirm(`Вы уверены, что хотите удалить список "${listName}"? Это действие необратимо и удалит ВСЕ папки и элементы в нем.`)) return;
    
    showLoading();
    const { error } = await supabase
        .from('shared_lists')
        .delete()
        .eq('id', listId);
        
    if (error) {
        showNotification('Ошибка: ' + error.message, 'error');
    } else {
        allUserLists = allUserLists.filter(l => l.id !== listId);
        currentList = null;
        renderSidebar();
        welcomeMessage.style.display = 'flex';
        listContentWrapper.style.display = 'none';
        container.classList.remove('list-selected');
        backToListsBtn.style.display = 'none';
        showNotification(`Список "${listName}" удален.`, 'success');
    }
    hideLoading();
}

async function handleNewFolderInList() {
    if (!currentList) return;
    const name = prompt("Введите название новой папки (н-р, 'Продукты'):");
    if (!name) return;
    
    showLoading();
    const { data, error } = await supabase
        .from('list_folders')
        .insert({ name: name, list_id: currentList.id })
        .select()
        .single();
        
    if (error) {
        showNotification('Ошибка: ' + error.message, 'error');
    } else {
        currentListFolders.push(data);
        renderMainView(); // Перерисовываем
        showNotification(`Папка "${name}" создана!`, 'success');
    }
    hideLoading();
}

async function handleDeleteFolder(folderId, folderName) {
    if (!confirm(`Удалить папку "${folderName}"? Все элементы из нее будут перемещены в "Без папки".`)) return;
    
    showLoading();
    // 1. Обнуляем folder_id у всех дочерних элементов
    const { error: updateError } = await supabase
        .from('list_items')
        .update({ folder_id: null })
        .eq('folder_id', folderId);
        
    if (updateError) {
        showNotification('Ошибка: ' + updateError.message, 'error');
        hideLoading();
        return;
    }

    // 2. Удаляем саму папку
    const { error: deleteError } = await supabase
        .from('list_folders')
        .delete()
        .eq('id', folderId);

    if (deleteError) {
        showNotification('Ошибка: ' + deleteError.message, 'error');
    } else {
        // Обновляем локальные данные и рендерим
        currentListFolders = currentListFolders.filter(f => f.id !== folderId);
        currentListItems.forEach(i => { if (i.folder_id === folderId) i.folder_id = null; });
        renderMainView();
        showNotification(`Папка "${folderName}" удалена.`, 'success');
    }
    hideLoading();
}

async function handleAddItem() {
    const content = newItemText.value.trim();
    if (!content || !currentList) return;
    
    // Временно добавляем в UI (в корень)
    const tempId = `temp-${Date.now()}`;
    const tempItem = { id: tempId, content: content, is_done: false, list_id: currentList.id, folder_id: null };
    const itemEl = createItemElement(tempItem);
    itemEl.style.opacity = '0.5';
    document.querySelector('.root-items-container').appendChild(itemEl);
    newItemText.value = '';

    const { data: newItem, error } = await supabase
        .from('list_items')
        .insert({ content: content, list_id: currentList.id, folder_id: null }) // По умолчанию в корень
        .select()
        .single();
    
    if (error) {
        showNotification('Ошибка: ' + error.message, 'error');
        itemEl.remove();
    } else {
        itemEl.remove(); // Удаляем временный
        currentListItems.push(newItem); // Добавляем настоящий
        const realItemEl = createItemElement(newItem); // Создаем настоящий
        document.querySelector('.root-items-container').appendChild(realItemEl);
    }
}

async function handleDeleteItem(itemId) {
    const itemEl = document.querySelector(`.list-item-entry[data-item-id="${itemId}"]`);
    if (itemEl) itemEl.style.opacity = '0.3';

    const { error } = await supabase
        .from('list_items')
        .delete()
        .eq('id', itemId);

    if (error) {
        showNotification('Ошибка: ' + error.message, 'error');
        if (itemEl) itemEl.style.opacity = '1';
    } else {
        if (itemEl) itemEl.remove();
        currentListItems = currentListItems.filter(i => i.id !== itemId);
    }
}

async function handleToggleItem(itemId, isDone) {
    const itemEl = document.querySelector(`.list-item-entry[data-item-id="${itemId}"]`);
    if (itemEl) itemEl.classList.toggle('done', isDone);

    const { error } = await supabase
        .from('list_items')
        .update({ is_done: isDone })
        .eq('id', itemId);

    if (error) {
        showNotification('Ошибка: ' + error.message, 'error');
        if (itemEl) itemEl.classList.toggle('done', !isDone); // Откат
    } else {
        const item = currentListItems.find(i => i.id === itemId);
        if (item) item.is_done = isDone;
    }
}

// =================================================================
// 6. ЛОГИКА "ПОДЕЛИТЬСЯ"
// =================================================================
// (Эта часть осталась почти без изменений, т.к. логика та же)

async function openShareModal() {
    if (!currentList) return;
    showLoading();
    const { data, error } = await supabase
        .from('shared_lists')
        .update({ is_public_editable: true })
        .eq('id', currentList.id)
        .select('share_token')
        .single();
    hideLoading();
    if (error) { showNotification('Ошибка: ' + error.message, 'error'); return; }

    currentList.is_public_editable = true;
    renderMainView(); // Обновить кнопку

    const shareUrl = `${window.location.origin}${window.location.pathname}?id=${data.share_token}`;
    shareLinkInput.value = shareUrl;
    shareModal.style.display = 'flex';
    setTimeout(() => shareModal.classList.add('visible'), 10);
}

function closeShareModal() {
    shareModal.classList.remove('visible');
    setTimeout(() => { shareModal.style.display = 'none'; }, 300);
}

function copyShareLink() {
    shareLinkInput.select();
    document.execCommand('copy');
    showNotification('Ссылка скопирована!', 'success');
}

async function disableSharing() {
    if (!currentList) return;
    if (!confirm('Отключить доступ по ссылке?')) return;
    showLoading();
    const { error } = await supabase
        .from('shared_lists')
        .update({ is_public_editable: false })
        .eq('id', currentList.id);
    hideLoading();
    if (error) { showNotification('Ошибка: ' + error.message, 'error'); return; }
    
    currentList.is_public_editable = false;
    renderMainView(); // Обновить кнопку
    showNotification('Доступ по ссылке отключен.', 'success');
    closeShareModal();
}

// =================================================================
// 7. РЕЖИМ ПУБЛИЧНОГО ПРОСМОТРА (по ?id=...)
// =================================================================

async function loadPublicList(shareToken) {
    showLoading();
    // 1. Получаем список, его папки и его элементы одним запросом
    const { data, error } = await supabase
        .from('shared_lists')
        .select('*, list_folders(*), list_items(*)')
        .eq('share_token', shareToken)
        .eq('is_public_editable', true)
        .single();
        
    hideLoading();
    if (error || !data) {
        console.error("Ошибка:", error);
        document.body.innerHTML = `<h2 style="color: var(--warning-color); text-align: center; margin-top: 50px;">Список не найден или доступ закрыт.</h2>`;
        return;
    }
    
    // RLS позволяет анониму это делать
    currentList = data;
    currentListFolders = data.list_folders || [];
    currentListItems = data.list_items || [];
    
    // Настраиваем UI
    renderMainView();
    
    // Скрываем/отключаем кнопки "для владельца"
    document.getElementById('list-new-folder-btn').style.display = 'none';
    document.getElementById('list-share-btn').style.display = 'none';
    document.querySelectorAll('.folder-delete-btn').forEach(btn => btn.style.display = 'none');
    
    // Включаем форму добавления
    listAddForm.onsubmit = (e) => {
        e.preventDefault();
        handleAddItem(); // Будет работать из-за RLS
    };
    
    // Включаем Drag-and-Drop
    setupDragAndDropListeners();
}

// =================================================================
// 8. ЛОГИКА DRAG & DROP
// =================================================================

function setupDragAndDropListeners() {
    const dropZones = document.querySelectorAll('.folder-container, .root-items-container');
    
    dropZones.forEach(zone => {
        zone.ondragover = (e) => {
            e.preventDefault();
            zone.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
        };
        
        zone.ondragleave = () => {
            zone.classList.remove('drag-over');
        };
        
        zone.ondrop = (e) => {
            e.preventDefault();
            zone.classList.remove('drag-over');
            if (!draggedItem) return;
            
            const itemId = draggedItem.dataset.itemId;
            let newFolderId = zone.dataset.folderId; // 'null' для корня
            if (newFolderId === 'null') newFolderId = null; 
            
            // 1. Перемещаем в DOM
            const targetList = zone.querySelector('.folder-items-list') || zone;
            targetList.appendChild(draggedItem);
            
            // 2. Обновляем в Supabase
            updateItemFolder(itemId, newFolderId);
        };
    });
}

async function updateItemFolder(itemId, newFolderId) {
    draggedItem.style.opacity = '0.5'; // Показываем "обработку"
    
    const { error } = await supabase
        .from('list_items')
        .update({ folder_id: newFolderId })
        .eq('id', itemId);
        
    if (error) {
        showNotification('Ошибка перемещения: ' + error.message, 'error');
        // Тут нужна логика отката, но для простоты просто перезагрузим
        loadListContent(currentList.id);
    } else {
        // Обновляем локальный кеш
        const item = currentListItems.find(i => i.id === itemId);
        if (item) item.folder_id = newFolderId;
        draggedItem.style.opacity = '1';
        showNotification('Элемент перемещен!', 'success', 2000);
    }
}

</script>

</body>
</html>
